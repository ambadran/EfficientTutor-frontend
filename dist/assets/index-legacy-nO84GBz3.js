System.register([],function(e,t){"use strict";return{execute:function(){var n,a=document.createElement("style");a.textContent='*,:before,:after{--tw-border-spacing-x: 0;--tw-border-spacing-y: 0;--tw-translate-x: 0;--tw-translate-y: 0;--tw-rotate: 0;--tw-skew-x: 0;--tw-skew-y: 0;--tw-scale-x: 1;--tw-scale-y: 1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness: proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width: 0px;--tw-ring-offset-color: #fff;--tw-ring-color: rgb(59 130 246 / .5);--tw-ring-offset-shadow: 0 0 #0000;--tw-ring-shadow: 0 0 #0000;--tw-shadow: 0 0 #0000;--tw-shadow-colored: 0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x: 0;--tw-border-spacing-y: 0;--tw-translate-x: 0;--tw-translate-y: 0;--tw-rotate: 0;--tw-skew-x: 0;--tw-skew-y: 0;--tw-scale-x: 1;--tw-scale-y: 1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness: proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width: 0px;--tw-ring-offset-color: #fff;--tw-ring-color: rgb(59 130 246 / .5);--tw-ring-offset-shadow: 0 0 #0000;--tw-ring-shadow: 0 0 #0000;--tw-shadow: 0 0 #0000;--tw-shadow-colored: 0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }*,:before,:after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}:before,:after{--tw-content: ""}html,:host{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}ol,ul,menu{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}button,[role=button]{cursor:pointer}:disabled{cursor:default}img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.container{width:100%}@media(min-width:640px){.container{max-width:640px}}@media(min-width:768px){.container{max-width:768px}}@media(min-width:1024px){.container{max-width:1024px}}@media(min-width:1280px){.container{max-width:1280px}}@media(min-width:1536px){.container{max-width:1536px}}.visible{visibility:visible}.absolute{position:absolute}.relative{position:relative}.sticky{position:sticky}.bottom-4{bottom:1rem}.right-0{right:0}.top-0{top:0}.z-40{z-index:40}.mx-2{margin-left:.5rem;margin-right:.5rem}.mx-auto{margin-left:auto;margin-right:auto}.my-2{margin-top:.5rem;margin-bottom:.5rem}.-mr-2{margin-right:-.5rem}.-mt-2{margin-top:-.5rem}.mb-1{margin-bottom:.25rem}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.ml-1{margin-left:.25rem}.ml-4{margin-left:1rem}.mr-1{margin-right:.25rem}.mr-2{margin-right:.5rem}.mr-3{margin-right:.75rem}.mr-4{margin-right:1rem}.mt-1{margin-top:.25rem}.mt-10{margin-top:2.5rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.mt-auto{margin-top:auto}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.table{display:table}.grid{display:grid}.hidden{display:none}.h-16{height:4rem}.h-full{height:100%}.max-h-40{max-height:10rem}.max-h-48{max-height:12rem}.max-h-60{max-height:15rem}.min-h-\\[1\\.5rem\\]{min-height:1.5rem}.w-16{width:4rem}.w-24{width:6rem}.w-28{width:7rem}.w-48{width:12rem}.w-6{width:1.5rem}.w-auto{width:auto}.w-full{width:100%}.max-w-2xl{max-width:42rem}.max-w-3xl{max-width:48rem}.max-w-4xl{max-width:56rem}.max-w-md{max-width:28rem}.max-w-sm{max-width:24rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.flex-grow{flex-grow:1}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-not-allowed{cursor:not-allowed}.cursor-pointer{cursor:pointer}.select-all{-webkit-user-select:all;-moz-user-select:all;user-select:all}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.flex-col{flex-direction:column}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:.5rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-x-2>:not([hidden])~:not([hidden]){--tw-space-x-reverse: 0;margin-right:calc(.5rem * var(--tw-space-x-reverse));margin-left:calc(.5rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-3>:not([hidden])~:not([hidden]){--tw-space-x-reverse: 0;margin-right:calc(.75rem * var(--tw-space-x-reverse));margin-left:calc(.75rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-4>:not([hidden])~:not([hidden]){--tw-space-x-reverse: 0;margin-right:calc(1rem * var(--tw-space-x-reverse));margin-left:calc(1rem * calc(1 - var(--tw-space-x-reverse)))}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse: 0;margin-top:calc(.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem * var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse: 0;margin-top:calc(.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem * var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse: 0;margin-top:calc(.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem * var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse: 0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse: 0;margin-top:calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem * var(--tw-space-y-reverse))}.self-center{align-self:center}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.whitespace-nowrap{white-space:nowrap}.break-all{word-break:break-all}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-md{border-radius:.375rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-gray-500{--tw-border-opacity: 1;border-color:rgb(107 114 128 / var(--tw-border-opacity, 1))}.border-gray-600{--tw-border-opacity: 1;border-color:rgb(75 85 99 / var(--tw-border-opacity, 1))}.border-gray-700{--tw-border-opacity: 1;border-color:rgb(55 65 81 / var(--tw-border-opacity, 1))}.border-gray-800{--tw-border-opacity: 1;border-color:rgb(31 41 55 / var(--tw-border-opacity, 1))}.border-indigo-900\\/50{border-color:rgba(49,46,129,.5)}.bg-blue-500\\/30{background-color:rgba(59,130,246,.3)}.bg-blue-600{--tw-bg-opacity: 1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.bg-gray-300{--tw-bg-opacity: 1;background-color:rgb(209 213 219 / var(--tw-bg-opacity, 1))}.bg-gray-500\\/30{background-color:rgba(107,114,128,.3)}.bg-gray-600{--tw-bg-opacity: 1;background-color:rgb(75 85 99 / var(--tw-bg-opacity, 1))}.bg-gray-700{--tw-bg-opacity: 1;background-color:rgb(55 65 81 / var(--tw-bg-opacity, 1))}.bg-gray-800{--tw-bg-opacity: 1;background-color:rgb(31 41 55 / var(--tw-bg-opacity, 1))}.bg-gray-800\\/50{background-color:rgba(31,41,55,.5)}.bg-gray-900{--tw-bg-opacity: 1;background-color:rgb(17 24 39 / var(--tw-bg-opacity, 1))}.bg-gray-900\\/80{background-color:rgba(17,24,39,.8)}.bg-green-500\\/20{background-color:rgba(34,197,94,.2)}.bg-green-500\\/30{background-color:rgba(34,197,94,.3)}.bg-green-600{--tw-bg-opacity: 1;background-color:rgb(22 163 74 / var(--tw-bg-opacity, 1))}.bg-indigo-600{--tw-bg-opacity: 1;background-color:rgb(79 70 229 / var(--tw-bg-opacity, 1))}.bg-indigo-900\\/50{background-color:rgba(49,46,129,.5)}.bg-red-500\\/20{background-color:rgba(239,68,68,.2)}.bg-red-500\\/30{background-color:rgba(239,68,68,.3)}.bg-red-600{--tw-bg-opacity: 1;background-color:rgb(220 38 38 / var(--tw-bg-opacity, 1))}.bg-yellow-600{--tw-bg-opacity: 1;background-color:rgb(202 138 4 / var(--tw-bg-opacity, 1))}.p-1{padding:.25rem}.p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-12{padding-top:3rem;padding-bottom:3rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-8{padding-top:2rem;padding-bottom:2rem}.pb-2{padding-bottom:.5rem}.pb-4{padding-bottom:1rem}.pr-2{padding-right:.5rem}.pt-2{padding-top:.5rem}.pt-3{padding-top:.75rem}.pt-4{padding-top:1rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-5xl{font-size:3rem;line-height:1}.text-6xl{font-size:3.75rem;line-height:1}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.capitalize{text-transform:capitalize}.italic{font-style:italic}.text-blue-300{--tw-text-opacity: 1;color:rgb(147 197 253 / var(--tw-text-opacity, 1))}.text-blue-400{--tw-text-opacity: 1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}.text-gray-200{--tw-text-opacity: 1;color:rgb(229 231 235 / var(--tw-text-opacity, 1))}.text-gray-300{--tw-text-opacity: 1;color:rgb(209 213 219 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity: 1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity: 1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity: 1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity: 1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-green-300{--tw-text-opacity: 1;color:rgb(134 239 172 / var(--tw-text-opacity, 1))}.text-green-400{--tw-text-opacity: 1;color:rgb(74 222 128 / var(--tw-text-opacity, 1))}.text-green-500{--tw-text-opacity: 1;color:rgb(34 197 94 / var(--tw-text-opacity, 1))}.text-indigo-300{--tw-text-opacity: 1;color:rgb(165 180 252 / var(--tw-text-opacity, 1))}.text-indigo-400{--tw-text-opacity: 1;color:rgb(129 140 248 / var(--tw-text-opacity, 1))}.text-red-300{--tw-text-opacity: 1;color:rgb(252 165 165 / var(--tw-text-opacity, 1))}.text-red-400{--tw-text-opacity: 1;color:rgb(248 113 113 / var(--tw-text-opacity, 1))}.text-red-500{--tw-text-opacity: 1;color:rgb(239 68 68 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity: 1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-yellow-400{--tw-text-opacity: 1;color:rgb(250 204 21 / var(--tw-text-opacity, 1))}.opacity-50{opacity:.5}.shadow-lg{--tw-shadow: 0 10px 15px -3px rgb(0 0 0 / .1), 0 4px 6px -4px rgb(0 0 0 / .1);--tw-shadow-colored: 0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000),var(--tw-ring-shadow, 0 0 #0000),var(--tw-shadow)}.shadow-md{--tw-shadow: 0 4px 6px -1px rgb(0 0 0 / .1), 0 2px 4px -2px rgb(0 0 0 / .1);--tw-shadow-colored: 0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000),var(--tw-ring-shadow, 0 0 #0000),var(--tw-shadow)}.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-blur-sm{--tw-backdrop-blur: blur(4px);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.duration-300{transition-duration:.3s}:root{--bg-color: #1a1a1a;--surface-color: #2c2c2c;--primary-color: #4f46e5;--text-color: #e5e7eb;--text-muted-color: #9ca3af;--border-color: #404040;--school-color: #facc15;--sports-color: #f97316;--others-color: #4ade80;--tuition-color: #60a5fa;--sleep-color: #9333ea;-webkit-user-select:none;-moz-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;overscroll-behavior:none}.pt-safe{padding-top:max(env(safe-area-inset-top),1rem)}.pb-safe{padding-bottom:max(env(safe-area-inset-bottom),1rem)}.pl-safe{padding-left:env(safe-area-inset-left)}.pr-safe{padding-right:env(safe-area-inset-right)}input,textarea{-webkit-user-select:text;-moz-user-select:text;user-select:text}button,a{touch-action:manipulation}html.light{--bg-color: #f3f4f6;--surface-color: #ffffff;--primary-color: #4f46e5;--text-color: #111827;--text-muted-color: #6b7280;--border-color: #e5e7eb}body{font-family:Inter,sans-serif;background-color:var(--bg-color);color:var(--text-color);overscroll-behavior:none}.app-container{display:flex;height:100vh;width:100vw;overflow:hidden}.sidebar{width:250px;background-color:var(--surface-color);border-right:1px solid var(--border-color);transition:transform .3s ease-in-out;transform:translate(-100%);position:fixed;top:0;left:0;height:100%;z-index:50}.sidebar.open{transform:translate(0)}.main-content{flex-grow:1;transition:margin-left .3s ease-in-out;height:100vh;overflow-y:auto}.timetable-grid{position:relative;height:1440px}.time-label{height:60px}.event-bubble{position:absolute;left:0;right:0;margin:0 4px;padding:4px 8px;border-radius:8px;font-size:.8rem;overflow:hidden;border:1px solid rgba(0,0,0,.2);color:#111827}.modal-backdrop{position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.7);z-index:100;display:flex;align-items:center;justify-content:center;padding:1rem}.modal-content{background-color:var(--surface-color);padding:1.5rem;border-radius:1rem;width:100%;max-width:500px;display:flex;flex-direction:column;max-height:90vh}.modal-header,.modal-footer{flex-shrink:0}.modal-body{flex-grow:1;overflow-y:auto;padding-right:.5rem;margin-right:-.5rem;padding-bottom:1rem}.loader{border:4px solid #f3f3f3;border-top:4px solid #4f46e5;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}#status-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.8);z-index:200;display:flex;align-items:center;justify-content:center;text-align:center;color:#fff;flex-direction:column;gap:1rem}.share-dropdown{position:absolute;background-color:var(--surface-color);border:1px solid var(--border-color);border-radius:.5rem;padding:.5rem;z-index:120;max-height:150px;overflow-y:auto}@media(min-width:768px){.sidebar{position:static;transform:translate(0)}.main-content{margin-left:0}#menu-button{display:none}}.hover\\:scale-105:hover{--tw-scale-x: 1.05;--tw-scale-y: 1.05;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\\:bg-blue-500:hover{--tw-bg-opacity: 1;background-color:rgb(59 130 246 / var(--tw-bg-opacity, 1))}.hover\\:bg-blue-700:hover{--tw-bg-opacity: 1;background-color:rgb(29 78 216 / var(--tw-bg-opacity, 1))}.hover\\:bg-gray-500:hover{--tw-bg-opacity: 1;background-color:rgb(107 114 128 / var(--tw-bg-opacity, 1))}.hover\\:bg-gray-600:hover{--tw-bg-opacity: 1;background-color:rgb(75 85 99 / var(--tw-bg-opacity, 1))}.hover\\:bg-gray-700:hover{--tw-bg-opacity: 1;background-color:rgb(55 65 81 / var(--tw-bg-opacity, 1))}.hover\\:bg-green-500:hover{--tw-bg-opacity: 1;background-color:rgb(34 197 94 / var(--tw-bg-opacity, 1))}.hover\\:bg-green-700:hover{--tw-bg-opacity: 1;background-color:rgb(21 128 61 / var(--tw-bg-opacity, 1))}.hover\\:bg-indigo-700:hover{--tw-bg-opacity: 1;background-color:rgb(67 56 202 / var(--tw-bg-opacity, 1))}.hover\\:bg-indigo-800\\/50:hover{background-color:rgba(55,48,163,.5)}.hover\\:bg-red-500:hover{--tw-bg-opacity: 1;background-color:rgb(239 68 68 / var(--tw-bg-opacity, 1))}.hover\\:bg-red-700:hover{--tw-bg-opacity: 1;background-color:rgb(185 28 28 / var(--tw-bg-opacity, 1))}.hover\\:bg-red-800\\/50:hover{background-color:rgba(153,27,27,.5)}.hover\\:bg-yellow-500:hover{--tw-bg-opacity: 1;background-color:rgb(234 179 8 / var(--tw-bg-opacity, 1))}.hover\\:text-blue-300:hover{--tw-text-opacity: 1;color:rgb(147 197 253 / var(--tw-text-opacity, 1))}.hover\\:text-indigo-300:hover{--tw-text-opacity: 1;color:rgb(165 180 252 / var(--tw-text-opacity, 1))}.hover\\:text-red-300:hover{--tw-text-opacity: 1;color:rgb(252 165 165 / var(--tw-text-opacity, 1))}.hover\\:text-white:hover{--tw-text-opacity: 1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.hover\\:underline:hover{text-decoration-line:underline}.hover\\:opacity-80:hover{opacity:.8}.focus\\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\\:ring-2:focus{--tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow, 0 0 #0000)}.focus\\:ring-indigo-500:focus{--tw-ring-opacity: 1;--tw-ring-color: rgb(99 102 241 / var(--tw-ring-opacity, 1))}@media(min-width:768px){.md\\:col-span-2{grid-column:span 2 / span 2}.md\\:hidden{display:none}.md\\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.md\\:grid-cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}.md\\:p-6{padding:1.5rem}}@media(min-width:1024px){.lg\\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.lg\\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}}\n/*$vite$:1*/',document.head.appendChild(a),function(e){e.Unimplemented="UNIMPLEMENTED",e.Unavailable="UNAVAILABLE"}(n||(n={}));class s extends Error{constructor(e,t,n){super(e),this.message=e,this.code=t,this.data=n}}const r=e=>{const t=e.CapacitorCustomPlatform||null,a=e.Capacitor||{},r=a.Plugins=a.Plugins||{},i=()=>null!==t?t.name:(e=>{var t,n;return(null==e?void 0:e.androidBridge)?"android":(null===(n=null===(t=null==e?void 0:e.webkit)||void 0===t?void 0:t.messageHandlers)||void 0===n?void 0:n.bridge)?"ios":"web"})(e),o=e=>{var t;return null===(t=a.PluginHeaders)||void 0===t?void 0:t.find(t=>t.name===e)},d=new Map;return a.convertFileSrc||(a.convertFileSrc=e=>e),a.getPlatform=i,a.handleError=t=>e.console.error(t),a.isNativePlatform=()=>"web"!==i(),a.isPluginAvailable=e=>{const t=d.get(e);return!!(null==t?void 0:t.platforms.has(i()))||!!o(e)},a.registerPlugin=(e,l={})=>{const c=d.get(e);if(c)return console.warn(`Capacitor plugin "${e}" already registered. Cannot register plugins twice.`),c.proxy;const u=i(),m=o(e);let g;const b=r=>{let i;const o=(...o)=>{const d=(async()=>(!g&&u in l?g=g="function"==typeof l[u]?await l[u]():l[u]:null!==t&&!g&&"web"in l&&(g=g="function"==typeof l.web?await l.web():l.web),g))().then(t=>{const d=((t,r)=>{var i,o;if(!m){if(t)return null===(o=t[r])||void 0===o?void 0:o.bind(t);throw new s(`"${e}" plugin is not implemented on ${u}`,n.Unimplemented)}{const n=null==m?void 0:m.methods.find(e=>r===e.name);if(n)return"promise"===n.rtype?t=>a.nativePromise(e,r.toString(),t):(t,n)=>a.nativeCallback(e,r.toString(),t,n);if(t)return null===(i=t[r])||void 0===i?void 0:i.bind(t)}})(t,r);if(d){const e=d(...o);return i=null==e?void 0:e.remove,e}throw new s(`"${e}.${r}()" is not implemented on ${u}`,n.Unimplemented)});return"addListener"===r&&(d.remove=async()=>i()),d};return o.toString=()=>`${r.toString()}() { [capacitor code] }`,Object.defineProperty(o,"name",{value:r,writable:!1,configurable:!1}),o},p=b("addListener"),y=b("removeListener"),v=(e,t)=>{const n=p({eventName:e},t),a=async()=>{const a=await n;y({eventName:e,callbackId:a},t)},s=new Promise(e=>n.then(()=>e({remove:a})));return s.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await a()},s},f=new Proxy({},{get(e,t){switch(t){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return m?v:p;case"removeListener":return y;default:return b(t)}}});return r[e]=f,d.set(e,{name:e,proxy:f,platforms:new Set([...Object.keys(l),...m?[u]:[]])}),f},a.Exception=s,a.DEBUG=!!a.DEBUG,a.isLoggingEnabled=!!a.isLoggingEnabled,a},i=(e=>e.Capacitor=r(e))("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}),o=i.registerPlugin;class d{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(e,t){let n=!1;this.listeners[e]||(this.listeners[e]=[],n=!0),this.listeners[e].push(t);const a=this.windowListeners[e];return a&&!a.registered&&this.addWindowListener(a),n&&this.sendRetainedArgumentsForEvent(e),Promise.resolve({remove:async()=>this.removeListener(e,t)})}async removeAllListeners(){this.listeners={};for(const e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,t,n){const a=this.listeners[e];if(a)a.forEach(e=>e(t));else if(n){let n=this.retainedEventArguments[e];n||(n=[]),n.push(t),this.retainedEventArguments[e]=n}}hasListeners(e){var t;return!!(null===(t=this.listeners[e])||void 0===t?void 0:t.length)}registerWindowListener(e,t){this.windowListeners[t]={registered:!1,windowEventName:e,pluginEventName:t,handler:e=>{this.notifyListeners(t,e)}}}unimplemented(e="not implemented"){return new i.Exception(e,n.Unimplemented)}unavailable(e="not available"){return new i.Exception(e,n.Unavailable)}async removeListener(e,t){const n=this.listeners[e];if(!n)return;const a=n.indexOf(t);this.listeners[e].splice(a,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}sendRetainedArgumentsForEvent(e){const t=this.retainedEventArguments[e];t&&(delete this.retainedEventArguments[e],t.forEach(t=>{this.notifyListeners(e,t)}))}}e("W",d);const l=e=>encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),c=e=>e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class u extends d{async getCookies(){const e=document.cookie,t={};return e.split(";").forEach(e=>{if(e.length<=0)return;let[n,a]=e.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");n=c(n).trim(),a=c(a).trim(),t[n]=a}),t}async setCookie(e){try{const t=l(e.key),n=l(e.value),a=`; expires=${(e.expires||"").replace("expires=","")}`,s=(e.path||"/").replace("path=",""),r=null!=e.url&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${t}=${n||""}${a}; path=${s}; ${r};`}catch(t){return Promise.reject(t)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(t){return Promise.reject(t)}}async clearCookies(){try{const e=document.cookie.split(";")||[];for(const t of e)document.cookie=t.replace(/^ +/,"").replace(/=.*/,`=;expires=${(new Date).toUTCString()};path=/`)}catch(e){return Promise.reject(e)}}async clearAllCookies(){try{await this.clearCookies()}catch(e){return Promise.reject(e)}}}o("CapacitorCookies",{web:()=>new u});const m=(e,t={})=>{const n=Object.assign({method:e.method||"GET",headers:e.headers},t),a=((e={})=>{const t=Object.keys(e);return Object.keys(e).map(e=>e.toLocaleLowerCase()).reduce((n,a,s)=>(n[a]=e[t[s]],n),{})})(e.headers)["content-type"]||"";if("string"==typeof e.data)n.body=e.data;else if(a.includes("application/x-www-form-urlencoded")){const t=new URLSearchParams;for(const[n,a]of Object.entries(e.data||{}))t.set(n,a);n.body=t.toString()}else if(a.includes("multipart/form-data")||e.data instanceof FormData){const t=new FormData;if(e.data instanceof FormData)e.data.forEach((e,n)=>{t.append(n,e)});else for(const n of Object.keys(e.data))t.append(n,e.data[n]);n.body=t;const a=new Headers(n.headers);a.delete("content-type"),n.headers=a}else(a.includes("application/json")||"object"==typeof e.data)&&(n.body=JSON.stringify(e.data));return n};class g extends d{async request(e){const t=m(e,e.webFetchExtra),n=((e,t=!0)=>e?Object.entries(e).reduce((e,n)=>{const[a,s]=n;let r,i;return Array.isArray(s)?(i="",s.forEach(e=>{r=t?encodeURIComponent(e):e,i+=`${a}=${r}&`}),i.slice(0,-1)):(r=t?encodeURIComponent(s):s,i=`${a}=${r}`),`${e}&${i}`},"").substr(1):null)(e.params,e.shouldEncodeUrlParams),a=n?`${e.url}?${n}`:e.url,s=await fetch(a,t),r=s.headers.get("content-type")||"";let i,o,{responseType:d="text"}=s.ok?e:{};switch(r.includes("application/json")&&(d="json"),d){case"arraybuffer":case"blob":o=await s.blob(),i=await(async e=>new Promise((t,n)=>{const a=new FileReader;a.onload=()=>{const e=a.result;t(e.indexOf(",")>=0?e.split(",")[1]:e)},a.onerror=e=>n(e),a.readAsDataURL(e)}))(o);break;case"json":i=await s.json();break;default:i=await s.text()}const l={};return s.headers.forEach((e,t)=>{l[t]=e}),{data:i,headers:l,status:s.status,url:s.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}}o("CapacitorHttp",{web:()=>new g});const b={backendUrl:i.isNativePlatform()?"https://personal-time-manager.onrender.com":"127.0.0.1"===window.location.hostname||"localhost"===window.location.hostname||"0.0.0.0"===window.location.hostname?"http://127.0.0.1:8000":"https://personal-time-manager.onrender.com",subjects:["Math","Physics","Chemistry","Biology","IT"],noteSubjects:["Math","Physics","Chemistry","Biology","IT","Geography"],noteTypes:["STUDY_NOTES","HOMEWORK","PAST_PAPERS"],educationalSystems:["IGCSE","SAT","National-EG","National-KW"],colors:{school:"var(--school-color)",sports:"var(--sports-color)",others:"var(--others-color)",tuition:"var(--tuition-color)",sleep:"var(--sleep-color)"},defaultSchoolTimes:{start:"06:00",end:"15:00"},defaultSleepTimes:{start:"22:00",end:"05:00"},daysOfWeek:["Saturday","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday"],timeSlotsStartHour:5,pixelsPerMinute:1,version:"v0.2"};let p={currentUser:null,students:[],currentStudent:null,currentPage:"login",currentTimetableDay:(new Date).getDay()+1>6?0:(new Date).getDay()+1,isSidebarOpen:!1,teacherTuitionLogs:[],notes:[],allStudents:[],notesStudentFilter:null};function y(e,t,n,a){h();const s=document.getElementById("modal-container"),r=document.createElement("div");r.id="modal-backdrop",r.className="modal-backdrop",r.innerHTML=`\n        <div class="modal-content">\n            <div class="modal-header flex justify-between items-center mb-4">\n                <h3 class="text-xl font-semibold">${e}</h3>\n                <button id="modal-close-btn" class="p-2 rounded-full hover:bg-gray-700 -mr-2 -mt-2"><i class="fas fa-times"></i></button>\n            </div>\n            <div class="modal-body">${t}</div>\n            <div class="modal-footer mt-4">${n}</div>\n        </div>`,s.appendChild(r),a&&a(r)}function v(e,t,n,a){const s=document.getElementById("modal-container"),r=document.createElement("div");r.className="modal-backdrop",r.style.zIndex="110",r.innerHTML=`\n        <div class="modal-content">\n            <div class="modal-header flex justify-between items-center mb-4">\n                <h3 class="text-xl font-semibold">${e}</h3>\n                <button class="dialog-close-btn p-2 rounded-full hover:bg-gray-700 -mr-2 -mt-2"><i class="fas fa-times"></i></button>\n            </div>\n            <div class="modal-body">${t}</div>\n            <div class="modal-footer mt-4">${n}</div>\n        </div>`,r.querySelector(".dialog-close-btn").addEventListener("click",()=>x(r)),s.appendChild(r),a&&a(r)}function f(e,t,n){y(e,`<p>${t}</p>`,'\n        <div class="flex justify-end space-x-4">\n            <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button>\n            <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-md">Confirm</button>\n        </div>',e=>{e.querySelector("#modal-confirm-btn").addEventListener("click",()=>{h(),n()}),e.querySelector("#modal-cancel-btn").addEventListener("click",()=>h())})}function h(){document.getElementById("modal-backdrop")?.remove()}function x(e){e&&e.remove()}const w=document.getElementById("status-overlay-container");function $(e){w.innerHTML=`<div id="status-overlay"><div class="loader"></div><p>${e}</p></div>`}function k(e,t){const n="success"===e?'<i class="fas fa-check-circle text-5xl text-green-500"></i>':'<i class="fas fa-times-circle text-5xl text-red-500"></i>';w.innerHTML=`<div id="status-overlay">${n}<p>${t}</p></div>`,setTimeout(S,2e3)}function S(){w.innerHTML=""}function _(e,t="error"){const n=document.getElementById("auth-feedback");if(!n)return;const a="success"===t?"text-green-400":"text-red-400";n.innerHTML=`<p class="${a} text-sm font-medium">${e}</p>`}function j(){const e=document.getElementById("auth-feedback");e&&(e.innerHTML="")}function E(){p.isSidebarOpen=!p.isSidebarOpen,document.getElementById("sidebar").classList.toggle("open")}function L(e){document.getElementById("page-title").textContent="Error",document.getElementById("page-content").innerHTML=`\n        <div class="text-center p-8 bg-gray-800 rounded-lg">\n            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>\n            <h3 class="text-xl font-semibold text-red-400">Application Error</h3>\n            <p class="text-gray-400 mt-2">${e}</p>\n            <p class="text-xs text-gray-500 mt-4">This could be a temporary issue with the backend server or your network connection. Please try refreshing the page.</p>\n            <button id="retry-connection-btn" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Retry Connection</button>\n        </div>`}function I(e,t,n=[]){const a=b.daysOfWeek[p.currentTimetableDay].toLowerCase(),s=t.availability&&t.availability[a]||[],r=e?[]:n.filter(e=>e.day===a);let i="";for(let c=b.timeSlotsStartHour;c<24+b.timeSlotsStartHour;c++){const e=c%24;let t=e%12;0===t&&(t=12),i+=`<div class="time-label text-right pr-2 text-xs text-gray-500 border-t border-gray-700 flex items-center justify-end">${t} ${e>=12?"PM":"AM"}</div>`}const o=e=>{if(!e)return 0;const[t,n]=e.split(":").map(Number);let a=60*t+n;return t<b.timeSlotsStartHour&&(a+=1440),(a-60*b.timeSlotsStartHour)*b.pixelsPerMinute},d=(t,n,a)=>{if(a<=0)return"";const s=!!t.subject,r=s?"tuition":t.type,i=b.colors[r]||b.colors.others,o=s?t.subject:t.type;return`<div class="event-bubble ${"tuition"!==r&&e?"cursor-pointer":""} hover:opacity-80" style="background-color: ${i}; top: ${n}px; height: ${a}px;" data-type="${r}" data-start="${t.start}" data-end="${t.end}">\n                    <p class="font-bold capitalize">${o}</p>\n                    <p>${t.start} - ${t.end}</p>\n                </div>`},l=[...s,...r].map(e=>{if(!e.start||!e.end)return"";const t=o(e.start),n=o(e.end);if(n<t){const a=1440*b.pixelsPerMinute,s=n;return d(e,t,a-t)+d(e,0,s)}return d(e,t,n-t)}).join("");return`\n        <div class="timetable-component">\n            ${e?'\n        <div class="flex space-x-2 mb-4">\n            <button class="set-all-times-btn flex-1 text-sm bg-gray-600 hover:bg-gray-500 rounded-md py-2" data-type="school"><i class="fas fa-school mr-2"></i> Set All School Times</button>\n            <button class="set-all-times-btn flex-1 text-sm bg-gray-600 hover:bg-gray-500 rounded-md py-2" data-type="sleep"><i class="fas fa-bed mr-2"></i> Set All Sleep Times</button>\n        </div>':""}\n            ${e||"parent"!==p.currentUser?.role||p.students.length<=1?"":`<div class="mb-4"><label for="student-selector" class="text-sm text-gray-400">Viewing Timetable for:</label><select id="student-selector" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">${p.students.map(e=>`<option value="${e.id}" ${p.currentStudent&&p.currentStudent.id===e.id?"selected":""}>${e.firstName} ${e.lastName}</option>`).join("")}</select></div>`}\n            <div class="flex justify-between items-center p-4 bg-gray-800 rounded-lg mb-4">\n                <button class="day-nav-btn p-2 rounded-md hover:bg-gray-700" data-direction="-1"><i class="fas fa-chevron-left"></i></button>\n                <h3 class="text-xl font-semibold">${b.daysOfWeek[p.currentTimetableDay]}</h3>\n                <button class="day-nav-btn p-2 rounded-md hover:bg-gray-700" data-direction="1"><i class="fas fa-chevron-right"></i></button>\n            </div>\n            <div class="flex">\n                <div class="w-16 flex-shrink-0">${i}</div>\n                <div class="timetable-grid flex-grow bg-gray-800/50 rounded-lg" id="timetable-grid-main" data-day-key="${a}">\n                    ${l}\n                </div>\n            </div>\n        </div>`}const T={showAddEventModal:function(e,t,n,a){const s=n/b.pixelsPerMinute+60*b.timeSlotsStartHour,r=Math.floor(s/60)%24,i=15*Math.floor(s%60/15),o=`${String(r).padStart(2,"0")}:${String(i).padStart(2,"0")}`;v("Add Activity",`<div class="space-y-4"><div><label class="text-sm text-gray-400">Activity Type</label><select id="add-event-type" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"><option value="sports">Sports Activity</option><option value="others">Others</option></select></div><div class="grid grid-cols-2 gap-4"><div><label class="text-sm text-gray-400">Start Time</label><input type="time" id="add-event-start" value="${o}" step="900" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div><div><label class="text-sm text-gray-400">End Time</label><input type="time" id="add-event-end" value="${o}" step="900" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div></div></div>`,'<div class="flex justify-end space-x-4"><button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button><button id="modal-confirm-add-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Add</button></div>',n=>{n.addEventListener("click",s=>{if(s.target.closest("#modal-cancel-btn")&&x(n),s.target.closest("#modal-confirm-add-btn")){const s=n.querySelector("#add-event-type").value,r=n.querySelector("#add-event-start").value,i=n.querySelector("#add-event-end").value;r&&i?(e.availability[t].push({type:s,start:r,end:i}),a(),x(n)):alert("Please set start and end times.")}})})},showEditEventModal:function(e,t,n,a){const s=e.availability[t],r=s.findIndex(e=>e.start===n);if(-1===r)return;const i=s[r],o=`<div class="grid grid-cols-2 gap-4"><div><label class="text-sm text-gray-400">Start Time</label><input type="time" id="edit-event-start" value="${i.start}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div><div><label class="text-sm text-gray-400">End Time</label><input type="time" id="edit-event-end" value="${i.end}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div></div><button id="delete-event-btn" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Delete Event</button>`;v(`Edit ${i.type} Activity`,o,'<div class="flex justify-end space-x-4"><button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button><button id="modal-confirm-edit-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Save Changes</button></div>',e=>{e.addEventListener("click",t=>{const n=t.target.closest("button");if(n)if("modal-cancel-btn"===n.id)x(e);else if("modal-confirm-edit-btn"===n.id){const t=e.querySelector("#edit-event-start").value,n=e.querySelector("#edit-event-end").value;s[r]={...i,start:t,end:n},a(),x(e)}else"delete-event-btn"===n.id&&(s.splice(r,1),a(),x(e))})})},showSetAllTimesModal:function(e,t,n){const a="school"===t?b.defaultSchoolTimes:b.defaultSleepTimes,s=`<div class="grid grid-cols-2 gap-4"><div><label class="text-sm text-gray-400">Start Time</label><input type="time" id="set-all-start" value="${a.start}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div><div><label class="text-sm text-gray-400">End Time</label><input type="time" id="set-all-end" value="${a.end}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div></div>`;v(`Set All ${t.charAt(0).toUpperCase()+t.slice(1)} Times`,s,'<div class="flex justify-end space-x-4"><button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button><button id="modal-confirm-set-all-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Apply to All Days</button></div>',a=>{a.addEventListener("click",s=>{if(s.target.closest("#modal-cancel-btn")&&x(a),s.target.closest("#modal-confirm-set-all-btn")){const s=a.querySelector("#set-all-start").value,r=a.querySelector("#set-all-end").value;("school"===t?["Sunday","Monday","Tuesday","Wednesday","Thursday"]:b.daysOfWeek).forEach(n=>{const a=n.toLowerCase(),i=e.availability[a].findIndex(e=>e.type===t);i>-1?(e.availability[a][i].start=s,e.availability[a][i].end=r):e.availability[a].push({type:t,start:s,end:r})}),n(),x(a)}})})}};let N=null;function P(e){const t={};return b.daysOfWeek.forEach(e=>{t[e.toLowerCase()]=[]}),e?(e.forEach(e=>{const n=b.daysOfWeek[e.day_of_week-1]?.toLowerCase();n&&t[n].push({type:e.availability_type,start:e.start_time.slice(0,5),end:e.end_time.slice(0,5)})}),t):t}function C(e){const t=[];return b.daysOfWeek.forEach((n,a)=>{const s=n.toLowerCase();(e[s]||[]).forEach(e=>{t.push({day_of_week:a+1,start_time:5===e.start.length?`${e.start}:00`:e.start,end_time:5===e.end.length?`${e.end}:00`:e.end,availability_type:e.type})})}),t}async function A(){const e=p.currentUser?.role;if(!e)return'<div class="text-center p-8 text-red-400">User role not found.</div>';try{if($("Loading Profile..."),"teacher"===e){const e=await async function(e=p.currentUser?.id){const[t,n,a,s]=await Promise.all([_e(e),Te(e),Le(),Ie()]),r=a.map(e=>`<option value="${e}" ${t.timezone===e?"selected":""}>${e}</option>`).join(""),i=s.map(e=>`<option value="${e}" ${t.currency===e?"selected":""}>${e}</option>`).join(""),o=`\n        <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-6">\n            <h3 class="text-xl font-semibold mb-4 text-indigo-300">Personal Information</h3>\n            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">\n                <div>\n                    <label class="block text-sm font-medium text-gray-400">First Name</label>\n                    <input type="text" id="profile-first-name" value="${t.first_name||""}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-400">Last Name</label>\n                    <input type="text" id="profile-last-name" value="${t.last_name||""}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-400">Email</label>\n                    <input type="email" id="profile-email" value="${t.email||""}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-400">Timezone</label>\n                    <select id="profile-timezone" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                        <option value="">Select Timezone</option>\n                        ${r}\n                    </select>\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-400">Currency</label>\n                    <select id="profile-currency" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                        <option value="">Select Currency</option>\n                        ${i}\n                    </select>\n                </div>\n                 <div>\n                    <label class="block text-sm font-medium text-gray-400">Password</label>\n                    <input type="password" disabled placeholder="Change Password coming soon..." class="w-full mt-1 p-2 bg-gray-900 text-gray-500 rounded-md border border-gray-800 cursor-not-allowed">\n                </div>\n            </div>\n            <div class="mt-6 text-right">\n                <button id="save-teacher-profile-btn" data-user-id="${e}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md transition duration-300">\n                    Save Changes\n                </button>\n            </div>\n        </div>\n    `,d=n.length>0?n.map(t=>`\n            <div class="flex justify-between items-center bg-gray-700 p-3 rounded-md mb-2 border border-gray-600">\n                <div>\n                    <span class="font-bold text-indigo-300">${t.subject}</span> \n                    <span class="text-sm text-gray-300 mx-2">•</span>\n                    <span class="text-sm text-gray-300">${t.educational_system}</span>\n                    <span class="text-sm text-gray-300 mx-2">•</span>\n                    <span class="text-sm text-gray-300">Grade ${t.grade}</span>\n                </div>\n                <button class="delete-specialty-btn text-red-400 hover:text-red-300 p-2 rounded hover:bg-gray-600" data-id="${t.id}" data-teacher-id="${e}">\n                    <i class="fas fa-trash"></i>\n                </button>\n            </div>\n        `).join(""):'<p class="text-gray-400 text-center py-4">No specialties added yet.</p>';return`\n        <div class="max-w-4xl mx-auto">\n            <h2 class="text-2xl font-bold mb-6">Teacher Profile</h2>\n            ${o}\n            \n        <div class="bg-gray-800 p-6 rounded-lg shadow-md">\n            <div class="flex justify-between items-center mb-4">\n                <h3 class="text-xl font-semibold text-indigo-300">Specialties</h3>\n                <button id="open-add-specialty-modal-btn" data-user-id="${e}" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-md">\n                    <i class="fas fa-plus mr-2"></i> Add Specialty\n                </button>\n            </div>\n            <div class="specialties-list-container">\n                ${d}\n            </div>\n        </div>\n    \n        </div>\n    `}();return S(),e}if("parent"===e){const e=await async function(e=p.currentUser?.id){const[t,n,a]=await Promise.all([je(e),Le(),Ie()]),s=n.map(e=>`<option value="${e}" ${t.timezone===e?"selected":""}>${e}</option>`).join(""),r=a.map(e=>`<option value="${e}" ${t.currency===e?"selected":""}>${e}</option>`).join("");return`\n        <div class="max-w-3xl mx-auto">\n            <h2 class="text-2xl font-bold mb-6">Parent Profile</h2>\n            <div class="bg-gray-800 p-6 rounded-lg shadow-md">\n                <h3 class="text-xl font-semibold mb-4 text-indigo-300">Personal Information</h3>\n                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">\n                    <div>\n                        <label class="block text-sm font-medium text-gray-400">First Name</label>\n                        <input type="text" id="profile-first-name" value="${t.first_name||""}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                    </div>\n                    <div>\n                        <label class="block text-sm font-medium text-gray-400">Last Name</label>\n                        <input type="text" id="profile-last-name" value="${t.last_name||""}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                    </div>\n                    <div class="md:col-span-2">\n                        <label class="block text-sm font-medium text-gray-400">Email</label>\n                        <input type="email" id="profile-email" value="${t.email||""}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                    </div>\n                    <div>\n                        <label class="block text-sm font-medium text-gray-400">Timezone</label>\n                        <select id="profile-timezone" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                            <option value="">Select Timezone</option>\n                            ${s}\n                        </select>\n                    </div>\n                    <div>\n                        <label class="block text-sm font-medium text-gray-400">Currency</label>\n                        <select id="profile-currency" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                            <option value="">Select Currency</option>\n                            ${r}\n                        </select>\n                    </div>\n                    <div>\n                        <label class="block text-sm font-medium text-gray-400">Password</label>\n                        <input type="password" disabled placeholder="Change Password coming soon..." class="w-full mt-1 p-2 bg-gray-900 text-gray-500 rounded-md border border-gray-800 cursor-not-allowed">\n                    </div>\n                </div>\n                <div class="mt-6 text-right">\n                    <button id="save-parent-profile-btn" data-user-id="${e}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md transition duration-300">\n                        Save Changes\n                    </button>\n                </div>\n            </div>\n        </div>\n    `}();return S(),e}if("student"===e){const e=await U(p.currentUser.id,"view");return S(),e}return S(),`<div class="text-center p-8 text-gray-400">Profile editing for <strong>${e}</strong> is coming soon.</div>`}catch(t){return S(),console.error("Error rendering profile:",t),`<div class="text-center text-red-400 p-8">Error loading profile: ${t.message}</div>`}}async function U(e,t="view"){let n={};const a=p.currentUser?.role;if("create"!==t)try{n=await ae(e)}catch(w){return`<div class="text-center text-red-400">Error loading student: ${w.message}</div>`}if("create"===t||"edit"===t){if(N={...n,availability:"create"===t?{}:P(n.student_availability_intervals||[]),student_subjects:"create"===t?[]:n.student_subjects||[]},b.daysOfWeek.forEach(e=>{const t=e.toLowerCase();N.availability[t]||(N.availability[t]=[])}),"create"===t){const e=["sunday","monday","tuesday","wednesday","thursday"];b.daysOfWeek.forEach(t=>{const n=t.toLowerCase();0===N.availability[n].length&&(N.availability[n].push({type:"sleep",...b.defaultSleepTimes}),e.includes(n)&&N.availability[n].push({type:"school",...b.defaultSchoolTimes}))})}}else N=null;const s="edit"===t||"create"===t,r="create"===t,i="student"===a,o="teacher"===a,d=o?`\n        <div>\n            <label class="block text-sm font-medium text-gray-400">Status</label>\n            <select id="st-status" ${s?"":"disabled"} class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                ${l=["NONE","Alpha","Omega","Sigma","HIM"],c=n.status||"NONE",l.map(e=>`<option value="${e}" ${e===c?"selected":""}>${e}</option>`).join("")}\n            </select>\n        </div>\n        <div>\n            <label class="block text-sm font-medium text-gray-400">Hourly Cost (kwd)</label>\n            <input type="number" id="st-cost" value="${n.cost||6}" step="0.5" ${s?"":"disabled"} class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n        </div>\n    `:"";var l,c;const u=o?`\n        <div>\n            <label class="block text-sm font-medium text-gray-400">Min Duration (mins)</label>\n            <input type="number" id="st-min-duration" value="${n.min_duration_mins||60}" step="15" ${s?"":"disabled"} class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n        </div>\n        <div>\n            <label class="block text-sm font-medium text-gray-400">Max Duration (mins)</label>\n            <input type="number" id="st-max-duration" value="${n.max_duration_mins||90}" step="15" ${s?"":"disabled"} class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n        </div>\n    `:"",m=`\n        <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-6">\n            <h3 class="text-xl font-semibold mb-4 text-indigo-300">${r?"New Student Details":"Student Details"}</h3>\n            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">\n                <div>\n                    <label class="block text-sm font-medium text-gray-400">First Name</label>\n                    <input type="text" id="st-first-name" value="${n.first_name||""}" ${s?"":"disabled"} class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-400">Last Name</label>\n                    <input type="text" id="st-last-name" value="${n.last_name||""}" ${s?"":"disabled"} class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-400">Grade (1-12)</label>\n                    <input type="number" id="st-grade" value="${n.grade||""}" min="1" max="12" ${s?"":"disabled"} class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                </div>\n                \n                ${d}\n\n                 <div>\n                    <label class="block text-sm font-medium text-gray-400">Email</label>\n                    <input type="email" id="st-email" value="${n.email||""}" ${r?"":"disabled"} placeholder="${r?"Optional (auto-generated if empty)":""}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600 ${r?"":"opacity-50 cursor-not-allowed"}">\n                </div>\n                \n                ${u}\n            </div>\n            \n            ${r||i||!n.generated_password?"":`\n            <div class="mt-4 p-4 bg-gray-900 rounded-md border border-indigo-900/50">\n                <p class="text-sm text-indigo-300 font-semibold"><i class="fas fa-key mr-2"></i>Generated Credentials</p>\n                <div class="flex items-center justify-between mt-2">\n                    <p class="text-sm text-gray-400">Password: <span class="font-mono text-white select-all">${n.generated_password}</span></p>\n                    <p class="text-xs text-gray-500">Share this with the student.</p>\n                </div>\n            </div>`}\n\n            ${!r&&s?`\n            <div class="mt-6 text-right">\n                <button id="save-student-details-btn" data-student-id="${e}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md transition duration-300">Save Details</button>\n            </div>`:""}\n        </div>\n    `,g=s?N.student_subjects||[]:n.student_subjects||[],y=g.map(e=>e.teacher_id?_e(e.teacher_id).catch(()=>({first_name:"Unknown",last_name:"Teacher"})):e.teacherObject?Promise.resolve(e.teacherObject):Promise.resolve({first_name:"Pending",last_name:"Save"})),v=await Promise.all(y),f=g.map((t,n)=>{const a=v[n],r=`${a.first_name} ${a.last_name}`;return`\n        <div class="bg-gray-700 p-4 rounded-md border border-gray-600 mb-3 flex justify-between items-start">\n            <div>\n                <h4 class="font-bold text-indigo-300 text-lg">${t.subject}</h4>\n                <p class="text-sm text-gray-300">${t.educational_system} • Grade ${t.grade}</p>\n                <p class="text-sm text-gray-400 mt-1"><i class="fas fa-chalkboard-teacher mr-1"></i> Teacher: <span class="font-semibold text-gray-200">${r}</span></p>\n                <p class="text-sm text-gray-400">Lessons/Week: ${t.lessons_per_week}</p>\n            </div>\n            ${s?`<button class="remove-subject-btn text-red-400 hover:text-red-300 p-2" data-student-id="${e||"new"}" data-subject-index="${n}"><i class="fas fa-trash"></i></button>`:""}\n        </div>\n    `}).join(""),h=`\n        <div class="bg-gray-800 p-6 rounded-lg shadow-md">\n            <div class="flex justify-between items-center mb-4">\n                <h3 class="text-xl font-semibold text-indigo-300">Enrolled Subjects</h3>\n                ${s?`<button id="add-student-subject-btn" data-student-id="${e||"new"}" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-md"><i class="fas fa-plus mr-2"></i> Add Subject</button>`:""}\n            </div>\n            ${f||'<p class="text-gray-400 text-center py-4">No subjects enrolled.</p>'}\n        </div>\n    `;let x="";return s&&(x=`\n            <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-6">\n                <div class="flex justify-between items-center mb-4">\n                    <h3 class="text-xl font-semibold text-indigo-300">Availability</h3>\n                </div>\n                <div id="profile-timetable-wrapper">\n                    ${I(!0,N)}\n                </div>\n                ${r?"":`\n                <div class="mt-6 text-right">\n                    <button id="save-student-availability-btn" data-student-id="${e}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md transition duration-300">Save Availability</button>\n                </div>`}\n            </div>\n        `),`\n        <div class="max-w-4xl mx-auto space-y-6">\n             ${r?'<button id="cancel-create-student-btn" class="text-gray-400 hover:text-white mb-2"><i class="fas fa-arrow-left mr-2"></i> Back to List</button>':""}\n            ${m}\n            ${h}\n            ${x}\n            ${r?'\n                <div class="bg-gray-800 p-4 rounded-lg shadow-md flex justify-end sticky bottom-4 border-t border-gray-700">\n                    <button id="create-student-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-md transition duration-300 shadow-lg">\n                        Create Student\n                    </button>\n                </div>':""}\n        </div>\n    `}function B(){const e=document.getElementById("profile-timetable-wrapper");e&&N&&(e.innerHTML=I(!0,N))}function O(e,...t){if(!N)return;const n=()=>B();"add"===e?T.showAddEventModal(N,t[0],t[1],n):"edit"===e?T.showEditEventModal(N,t[0],t[1],n):"setAll"===e&&T.showSetAllTimesModal(N,t[0],n)}function D(e){const t=document.getElementById("sidebar-nav");if(!t)return;let n="";"parent"===e?n='\n            <a href="#" id="nav-timetable" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-calendar-alt w-6 mr-3"></i> Timetable</a>\n            <a href="#" id="nav-tuitions" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-chalkboard-teacher w-6 mr-3"></i> Tuitions</a>\n            <a href="#" id="nav-notes" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-book-open w-6 mr-3"></i> Notes</a>\n            <a href="#" id="nav-logs" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-history w-6 mr-3"></i> Logs</a>\n            <a href="#" id="nav-student-info" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-user-graduate w-6 mr-3"></i> Student Info</a>\n            <a href="#" id="nav-profile" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-user-circle w-6 mr-3"></i> Profile</a>\n            <a href="#" id="nav-settings" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-cog w-6 mr-3"></i> Settings</a>\n        ':"student"===e?n='\n            <a href="#" id="nav-timetable" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-calendar-alt w-6 mr-3"></i> Timetable</a>\n            <a href="#" id="nav-tuitions" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-chalkboard-teacher w-6 mr-3"></i> Tuitions</a>\n            <a href="#" id="nav-notes" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-book-open w-6 mr-3"></i> Notes</a>\n            <a href="#" id="nav-profile" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-user-circle w-6 mr-3"></i> Profile</a>\n            <a href="#" id="nav-settings" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-cog w-6 mr-3"></i> Settings</a>\n        ':"teacher"===e&&(n='\n            <a href="#" id="nav-teacher-tuition-logs" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-file-invoice-dollar w-6 mr-3"></i> Tuition Logs</a>\n            <a href="#" id="nav-teacher-payment-logs" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-money-check-alt w-6 mr-3"></i> Payment Logs</a>\n            <a href="#" id="nav-teacher-notes" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-book-open w-6 mr-3"></i> Notes</a>\n            <a href="#" id="nav-tuitions" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-chalkboard-teacher w-6 mr-3"></i> Tuitions</a>\n            <a href="#" id="nav-teacher-student-info" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-users w-6 mr-3"></i> Student Info</a>\n            <a href="#" id="nav-profile" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-user-circle w-6 mr-3"></i> Profile</a>\n        '),t.innerHTML=n,e?t.classList.remove("hidden"):t.classList.add("hidden")}async function q(){try{$("Loading tuitions...");const[e,t]=await Promise.all([re(),le()]),n=[],a=new Set;if(Array.isArray(e)&&e.forEach(e=>{e.tuition&&(n.push(e),a.add(e.tuition.id))}),Array.isArray(t)&&t.forEach(e=>{a.has(e.id)||n.push({start_time:null,end_time:null,tuition:e})}),p.teacherScheduledTuitions=n,S(),0===n.length)return'<div class="text-center p-8 text-gray-400">No tuitions found.</div>';const s=p.currentUser.role;return`<div class="space-y-6">${n.map(e=>function(e,t){const{tuition:n,start_time:a,end_time:s}=e;if(!n)return"";let r="";r=a?`\n            <p class="text-lg font-semibold capitalize">${new Date(a).toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"})}</p>\n            <p class="text-sm text-gray-400">${new Date(a).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})} - ${new Date(s).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}</p>\n        `:'<p class="text-lg font-semibold text-yellow-400">Unscheduled</p>';let i="";i="teacher"===t?`<p class="text-sm text-gray-400">${(n.charges||[]).map(e=>`${e.student.first_name} ${e.student.last_name}`).join(", ")}</p>`:`<p class="text-sm text-gray-400">${(n.attendee_names||[]).join(", ")}</p>`;let o="",d="";const l=n.meeting_link&&n.meeting_link.meeting_link;return"teacher"===t?(o=`\n            <div>\n                <h4 class="text-sm font-semibold text-gray-400 mb-2">Charges</h4>\n                <ul class="space-y-1">${(n.charges||[]).map(e=>`\n            <li class="flex justify-between items-center text-sm">\n                <span>${e.student.first_name} ${e.student.last_name}</span>\n                <span class="font-semibold">${e.cost} kwd</span>\n            </li>\n        `).join("")||'<li class="text-sm text-gray-500">No charges set.</li>'}</ul>\n            </div>\n        `,d=`\n            <div>\n                <h4 class="text-sm font-semibold text-gray-400 mb-2">Meeting Link</h4>\n                ${l?`<button class="view-meeting-link-btn w-full p-2 text-sm bg-blue-600 hover:bg-blue-500 rounded-md" data-tuition-id="${n.id}"><i class="fas fa-external-link-alt mr-2"></i>View Link</button>`:'<p class="text-gray-500 text-sm">No meeting link assigned.</p>'}\n                <div class="flex items-center space-x-2 mt-3">\n                     <button title="Set Link" class="edit-meeting-link-btn w-full p-2 text-sm bg-gray-600 hover:bg-gray-500 rounded-md" data-tuition-id="${n.id}"><i class="fas fa-edit"></i> ${l?"Edit":"Set"} Link</button>\n                </div>\n            </div>\n        `):"parent"===t?(o=`\n            <div>\n                <h4 class="text-sm font-semibold text-gray-400 mb-2">Your Charge</h4>\n                <p class="text-2xl font-bold text-indigo-300">${n.charge} kwd</p>\n            </div>\n        `,l&&(d=`\n                <div class="self-center">\n                    <button class="view-meeting-link-btn w-full p-2 text-sm bg-blue-600 hover:bg-blue-500 rounded-md" data-tuition-id="${n.id}"><i class="fas fa-external-link-alt mr-2"></i>View Link</button>\n                </div>\n            `)):(o="<div></div>",l&&(d=`\n                <div class="flex flex-col space-y-2">\n                    <button class="view-meeting-link-btn w-full p-2 text-sm bg-blue-600 hover:bg-blue-500 rounded-md" data-tuition-id="${n.id}"><i class="fas fa-external-link-alt mr-2"></i>View Details</button>\n                    <a href="${n.meeting_link.meeting_link}" target="_blank" rel="noopener noreferrer" class="w-full text-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Join Meeting</a>\n                </div>\n            `)),`\n        <div class="bg-gray-800 p-4 rounded-lg shadow-md">\n            <div class="flex justify-between items-start mb-4">\n                <div>\n                    <h3 class="font-semibold text-xl text-indigo-300">${n.subject}</h3>\n                    ${i}\n                </div>\n                <div class="text-right flex-shrink-0 ml-4">\n                    ${r}\n                </div>\n            </div>\n\n            <div class="mt-4 pt-4 border-t border-gray-700 grid grid-cols-1 md:grid-cols-3 gap-6">\n                <div>\n                    <h4 class="text-sm font-semibold text-gray-400 mb-2">Details</h4>\n                    <div class="text-sm space-y-1">\n                        <p class="flex justify-between"><span>Duration:</span> <span class="font-semibold">${n.min_duration_minutes||"N/A"} mins</span></p>\n                        <p class="flex justify-between"><span>Lesson Index:</span> <span class="font-semibold">${n.lesson_index||"N/A"}</span></p>\n                    </div>\n                </div>\n                ${o}\n                ${d}\n            </div>\n        </div>\n    `}(e,s)).join("")}</div>`}catch(e){return console.error("Error rendering tuitions page:",e),S(),`<div class="text-center text-red-400 p-8">Error loading tuitions: ${e.message}</div>`}}function M(e){if(!e)return"N/A";try{return new Date(e).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0,timeZone:"UTC"})}catch(t){return"Invalid Time"}}function z(e){return 0===e.length?'<div class="text-center p-8 text-gray-400">No tuition logs found.</div>':(e.sort((e,t)=>new Date(t.start_time)-new Date(e.start_time)),`<div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-gray-900/80"><tr><th class="p-3 text-center">Week #</th><th class="p-3">Date</th><th class="p-3">Start Time</th><th class="p-3">End Time</th><th class="p-3 text-center">Duration</th><th class="p-3">Subject</th><th class="p-3">Attendees</th><th class="p-3">Total Cost</th><th class="p-3">Paid Status</th><th class="p-3">Log Status</th><th class="p-3">Type</th><th class="p-3">Actions</th></tr></thead><tbody>${e.map(e=>{const t="VOID"===e.status;return`\n            <tr class="${t?"opacity-50 bg-gray-800/50":"bg-gray-800"}">\n                <td class="p-3 font-mono text-center">${e.week_number}</td>\n                <td class="p-3">${function(e){if(!e)return"N/A";try{return new Date(e).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric",timeZone:"UTC"})}catch(t){return"Invalid Date"}}(e.start_time)}</td>\n                <td class="p-3">${M(e.start_time)}</td>\n                <td class="p-3">${M(e.end_time)}</td>\n                <td class="p-3 text-center">${e.duration}</td>\n                <td class="p-3">${e.subject}</td>\n                <td class="p-3">${(e.charges||[]).map(e=>e.student_name).join("<br>")}</td>\n                <td class="p-3">\n                    <div class="flex items-center justify-between">\n                        <span>${e.total_cost} kwd</span>\n                        <button title="View Charge Details" class="view-charges-btn text-blue-400 hover:text-blue-300" data-log-id="${e.id}"><i class="fas fa-info-circle"></i></button>\n                    </div>\n                </td>\n                <td class="p-3"><span class="px-2 py-1 text-xs rounded-full ${"Paid"===e.paid_status?"bg-green-500/30 text-green-300":"bg-red-500/30 text-red-300"}">${e.paid_status}</span></td>\n                <td class="p-3"><span class="px-2 py-1 text-xs rounded-full ${t?"bg-gray-500/30 text-gray-300":"bg-blue-500/30 text-blue-300"}">${e.status}</span></td>\n                <td class="p-3 text-gray-400">${e.create_type}</td>\n                <td class="p-3">\n                    <div class="flex items-center space-x-2">\n                        <button title="Correct Log" class="correct-log-btn p-2 text-sm bg-yellow-600 hover:bg-yellow-500 rounded-md ${t?"hidden":""}" data-log-id='${e.id}'><i class="fas fa-edit"></i></button>\n                        <button title="Void Log" class="void-log-btn p-2 text-sm bg-red-600 hover:bg-red-500 rounded-md ${t?"hidden":""}" data-log-id="${e.id}"><i class="fas fa-ban"></i></button>\n                    </div>\n                </td>\n            </tr>`}).join("")}</tbody></table></div>`)}async function F(e=null){const t=null!==e;let n={};const a=()=>{const a=new Date,s=e?.start_time||n.scheduled_start_time||a.toISOString(),r=e?.end_time||n.scheduled_end_time||new Date(a.getTime()+36e5).toISOString(),i=new Date(s).toISOString().slice(0,16),o=new Date(r).toISOString().slice(0,16);let d="",l=n.subject;"custom"===n.log_type?(d=`<div><p class="text-sm text-gray-400">Attendees: <span class="font-semibold text-gray-200">${n.charges.map(e=>`${e.student_name||n.all_students.find(t=>t.id===e.student_id).first_name} (${e.cost} kwd)`).join(", ")}</span></p></div>`,n.educational_system&&n.grade&&(l=`${n.subject} (${n.educational_system} - Grade ${n.grade})`)):d=`<div><p class="text-sm text-gray-400">Attendees: <span class="font-semibold text-gray-200">${n.student_names.join(", ")}</span></p></div>`;const c=`\n            <div class="space-y-4">\n                <div><p class="text-sm text-gray-400">Subject: <span class="font-semibold text-gray-200">${l}</span></p></div>\n                ${d}\n                ${"custom"===n.log_type?`<div><label class="text-sm text-gray-400">Lesson Index</label><input type="number" id="log-lesson-index" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600" value="${e?.lesson_index||1}" min="1"></div>`:""}\n                <div class="grid grid-cols-2 gap-4">\n                    <div><label class="text-sm text-gray-400">Start Time</label><input type="datetime-local" id="log-start-time" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600" value="${i}"></div>\n                    <div><label class="text-sm text-gray-400">End Time</label><input type="datetime-local" id="log-end-time" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600" value="${o}"></div>\n                </div>\n            </div>`;y(t?"Correct Tuition Log":"Add Tuition Log",c,'<div class="flex justify-end"><button id="submit-log-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Submit</button></div>',a=>{a.querySelector("#submit-log-btn").addEventListener("click",async()=>{let s={};s="scheduled"===n.log_type?{log_type:"SCHEDULED",tuition_id:n.tuition_id,start_time:new Date(a.querySelector("#log-start-time").value).toISOString(),end_time:new Date(a.querySelector("#log-end-time").value).toISOString()}:{log_type:"CUSTOM",teacher_id:p.currentUser.id,subject:n.subject,educational_system:n.educational_system,grade:n.grade,lesson_index:parseInt(a.querySelector("#log-lesson-index").value),start_time:new Date(a.querySelector("#log-start-time").value).toISOString(),end_time:new Date(a.querySelector("#log-end-time").value).toISOString(),charges:n.charges},$("Saving log...");try{t?await ge(e.id,s):await ue(s),h(),k("success","Log saved successfully."),Y()}catch(r){k("error",r.message)}})})},s=async()=>{$("Fetching tuitions...");try{const e=await ce();S();const t=e=>{if(!e)return"";try{const t=new Date(e);return new Intl.DateTimeFormat("en-US",{weekday:"short",hour:"numeric",minute:"2-digit",hour12:!0,timeZone:"UTC"}).format(t)}catch(t){return""}},s=e.map(e=>{const n=t(e.scheduled_start_time);return`<li class="p-3 hover:bg-gray-700 rounded-md cursor-pointer scheduled-item" data-tuition-id="${e.id}">${e.subject} - ${(e.student_names||[]).join(", ")} ${n?`<span class="text-gray-400">- ${n}</span>`:""}</li>`}).join("");y("Add From Schedule",`<div><h3 class="font-semibold mb-2">Select a Scheduled Tuition</h3><ul class="space-y-1 max-h-60 overflow-y-auto">${s}</ul></div>`,"",t=>{t.querySelectorAll(".scheduled-item").forEach(t=>{t.addEventListener("click",()=>{const s=e.find(e=>e.id===t.dataset.tuitionId),r=(s.charges||[]).map(e=>e.student_name);n={log_type:"scheduled",tuition_id:s.id,subject:s.subject,student_names:r,scheduled_start_time:s.scheduled_start_time,scheduled_end_time:s.scheduled_end_time},a()})})})}catch(e){S(),k("error",e.message)}},r=async()=>{$("Fetching data...");try{const[s,r]=await Promise.all([ne(),Te(p.currentUser.id)]);S();const i=s.map(n=>{const a=t?e.charges.find(e=>e.student_id===n.id):null,s=a?"checked":"",r=a?a.cost:"",i=a?"":"hidden";return`<label class="flex items-center justify-between p-2 hover:bg-gray-600 rounded-md"><div class="flex items-center space-x-2"><input type="checkbox" class="student-checkbox" data-student-id="${n.id}" data-student-name="${n.first_name}" ${s}><span>${n.first_name} ${n.last_name}</span></div><div class="w-24"><input type="number" class="student-cost-input w-full p-1 bg-gray-800 rounded-md border border-gray-500 text-sm ${i}" placeholder="Cost" step="0.5" value="${r}"></div></label>`}).join("");let o="";o=0===r.length?'<option value="" disabled selected>No specialties found. Please add specialties in your profile.</option>':r.map(e=>`<option value="${e.id}">${e.subject} (${e.educational_system} - Grade ${e.grade})</option>`).join("");const d=`\n                <div class="space-y-4">\n                    <div>\n                        <label class="text-sm text-gray-400">Select Students & Set Cost</label>\n                        <div class="max-h-40 overflow-y-auto space-y-1 mt-1 border border-gray-600 p-2 rounded-md">${i}</div>\n                    </div>\n                    <div>\n                        <label class="text-sm text-gray-400">Select Specialty</label>\n                        <select id="custom-specialty" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600" ${0===r.length?"disabled":""}>\n                            ${o}\n                        </select>\n                    </div>\n                </div>`;y("Add Custom Log",d,`<div class="flex justify-end"><button id="next-custom-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md" ${0===r.length?"disabled":""}>Next</button></div>`,i=>{if(t&&e.educational_system&&e.grade){const t=r.find(t=>t.subject===e.subject&&t.educational_system===e.educational_system&&t.grade===e.grade);t&&(i.querySelector("#custom-specialty").value=t.id)}i.querySelectorAll(".student-checkbox").forEach(e=>{e.addEventListener("change",e=>{e.target.closest("label").querySelector(".student-cost-input").classList.toggle("hidden",!e.target.checked)})}),i.querySelector("#next-custom-btn").addEventListener("click",()=>{const e=[],t=[];let o=!0;if(i.querySelectorAll(".student-checkbox:checked").forEach(n=>{if(!o)return;const a=n.closest("label").querySelector(".student-cost-input"),s=parseFloat(a.value);if(isNaN(s)||s<=0)return alert(`Please enter a valid cost for ${n.dataset.studentName}.`),void(o=!1);e.push({student_id:n.dataset.studentId,cost:s}),t.push(n.dataset.studentName)}),!o||0===e.length)return void(o&&alert("Please select at least one student and enter their cost."));const d=i.querySelector("#custom-specialty").value,l=r.find(e=>e.id===d);n={log_type:"custom",charges:e,student_names:t,all_students:s,subject:l.subject,educational_system:l.educational_system,grade:l.grade},a()})})}catch(s){S(),k("error",s.message)}};if(t){const t=(e.charges||[]).map(e=>e.student_name);n={log_type:e.create_type.toLowerCase(),subject:e.subject,educational_system:e.educational_system,grade:e.grade,student_names:t,tuition_id:e.tuition_id,charges:e.charges},"custom"===n.log_type?await r():a()}else y("Add New Tuition Log",'<div class="flex space-x-4"><button id="from-schedule-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md">From Schedule</button><button id="custom-entry-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md">Custom Entry</button></div>',"",e=>{e.querySelector("#from-schedule-btn").addEventListener("click",s),e.querySelector("#custom-entry-btn").addEventListener("click",r)})}async function H(){try{const e=await oe();p.teacherPaymentLogs=e;const t=function(e){return 0===e.length?'<div class="text-center p-8 text-gray-400">No payment logs found.</div>':(e.sort((e,t)=>new Date(t.payment_date)-new Date(e.payment_date)),`<div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-gray-900/80"><tr><th class="p-3">Date</th><th class="p-3">Parent</th><th class="p-3">Amount Paid</th><th class="p-3">Notes</th><th class="p-3">Status</th><th class="p-3">Actions</th></tr></thead><tbody>${e.map(e=>{const t="VOID"===e.status;return`\n            <tr class="${t?"opacity-50 bg-gray-800/50":"bg-gray-800"}">\n                <td class="p-3">${new Date(e.payment_date).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}</td>\n                <td class="p-3">${e.parent_name}</td>\n                <td class="p-3">${e.amount_paid} ${e.currency}</td>\n                <td class="p-3 text-gray-400 italic">${e.notes||"–"}</td>\n                <td class="p-3"><span class="px-2 py-1 text-xs rounded-full ${t?"bg-red-500/30 text-red-300":"bg-green-500/30 text-green-300"}">${e.status}</span></td>\n                <td class="p-3">\n                    <div class="flex items-center space-x-2">\n                        <button title="Correct Log" class="correct-payment-log-btn p-2 text-sm bg-yellow-600 hover:bg-yellow-500 rounded-md ${t?"hidden":""}" data-log-id="${e.id}"><i class="fas fa-edit"></i></button>\n                        <button title="Void Log" class="void-payment-log-btn p-2 text-sm bg-red-600 hover:bg-red-500 rounded-md ${t?"hidden":""}" data-log-id="${e.id}"><i class="fas fa-ban"></i></button>\n                    </div>\n                </td>\n            </tr>`}).join("")}</tbody></table></div>`)}(e);return`\n            <div class="space-y-6">\n                <div class="flex justify-between items-center">\n                    <h2 class="text-2xl font-bold">Payment Logs</h2>\n                    <button id="add-new-payment-log-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-300"><i class="fas fa-plus mr-2"></i> Add Payment</button>\n                </div>\n                ${t}\n            </div>`}catch(e){return console.error("Error rendering payment logs page:",e),`<div class="text-center text-red-400 p-8">Error loading payment logs: ${e.message}</div>`}}async function R(e=null){const t=null!==e;$("Loading...");try{const n=await be();S();const a=`<div class="space-y-4"><div><label class="text-sm text-gray-400">Parent</label><select id="payment-parent-id" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">${n.map(e=>`<option value="${e.id}">${e.first_name} ${e.last_name}</option>`).join("")}</select></div><div class="grid grid-cols-2 gap-4"><div><label class="text-sm text-gray-400">Payment Date</label><input type="date" id="payment-date" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div><div><label class="text-sm text-gray-400">Amount Paid</label><input type="number" id="payment-amount" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600" step="0.5" placeholder="0.00"></div></div><div><label class="text-sm text-gray-400">Notes (Optional)</label><textarea id="payment-notes" rows="3" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></textarea></div></div>`;y(t?"Correct Payment Log":"Add Payment Log",a,'<div class="flex justify-end"><button id="submit-payment-log-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Submit</button></div>',a=>{if(t){const t=n.find(t=>`${t.first_name} ${t.last_name}`===e.parent_name);t&&(a.querySelector("#payment-parent-id").value=t.id),a.querySelector("#payment-date").value=new Date(e.payment_date).toISOString().split("T")[0],a.querySelector("#payment-amount").value=e.amount_paid,a.querySelector("#payment-notes").value=e.notes||""}else a.querySelector("#payment-date").value=(new Date).toISOString().split("T")[0];a.querySelector("#submit-payment-log-btn").addEventListener("click",async()=>{const n={teacher_id:p.currentUser.id,parent_id:a.querySelector("#payment-parent-id").value,amount_paid:parseFloat(a.querySelector("#payment-amount").value),notes:a.querySelector("#payment-notes").value,payment_date:new Date(a.querySelector("#payment-date").value).toISOString()};if(n.parent_id&&n.amount_paid&&n.payment_date){$("Saving payment...");try{t?await ve(e.id,n):await pe(n),h(),k("success","Payment log saved."),Y()}catch(s){k("error",s.message)}}else alert("Please fill in Parent, Date, and Amount.")})})}catch(n){S(),k("error",`Could not load data: ${n.message}`)}}async function W(){"student"===p.currentUser.role&&(p.notesStudentFilter=p.currentUser.id);try{$("Loading Notes...");const e=await $e();if(p.notes=e,"student"!==p.currentUser.role){const e=await ne();p.allStudents=e}S();const t=function(){const e=p.currentUser?.role;if("parent"!==e&&"teacher"!==e)return"";const t=p.allStudents||[];return 0===t.length?'<p class="text-gray-400">No students found.</p>':`\n        <div class="max-w-sm">\n            <label for="notes-student-selector" class="block text-sm font-medium text-gray-400">Viewing Notes For:</label>\n            <select id="notes-student-selector" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                <option value="">Select a student...</option>\n                ${t.map(e=>`<option value="${e.id}" ${p.notesStudentFilter===e.id?"selected":""}>\n            ${e.first_name} ${e.last_name}\n        </option>`).join("")}\n            </select>\n        </div>\n    `}(),n=function(e){if(!p.notesStudentFilter)return'<div class="text-center p-8 text-gray-400 bg-gray-800 rounded-lg">Please select a student to view their notes.</div>';if(0===e.length)return'<div class="text-center p-8 text-gray-400 bg-gray-800 rounded-lg">No notes found for this student.</div>';const t=e.reduce((e,t)=>(e[t.subject]||(e[t.subject]=0),e[t.subject]++,e),{});return`\n        <div>\n            <h3 class="text-xl font-semibold mb-4">Subjects</h3>\n            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">\n                ${Object.entries(t).map(([e,t])=>`\n        <div class="subject-card-button bg-gray-800 hover:bg-indigo-800/50 p-6 rounded-lg text-center cursor-pointer transition-all duration-300 transform hover:scale-105" data-subject="${e}">\n            <i class="fas fa-folder text-4xl text-indigo-400 mb-3"></i>\n            <h3 class="font-bold text-lg">${e}</h3>\n            <p class="text-sm text-gray-400">${t} ${1===t?"Note":"Notes"}</p>\n        </div>\n    `).join("")}\n            </div>\n        </div>\n        <div id="notes-list-container" class="mt-8"></div>\n    `}(p.notesStudentFilter?p.notes.filter(e=>e.student.id===p.notesStudentFilter):[]);return`\n            <div class="space-y-6">\n                <div class="flex justify-between items-center">\n                    <h2 class="text-2xl font-bold">Notes</h2>\n                    ${"teacher"===p.currentUser.role?'<button id="add-new-note-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-300"><i class="fas fa-plus mr-2"></i> Add New Note</button>':""}\n                </div>\n                ${t}\n                <div id="notes-content-container">\n                    ${n}\n                </div>\n            </div>\n        `}catch(e){return S(),console.error("Error rendering notes page:",e),`<div class="text-center text-red-400 p-8">Error loading notes: ${e.message}</div>`}}const G=document.getElementById("page-content"),J=document.getElementById("page-title");function V(e){p.currentPage=e,p.isSidebarOpen&&E(),Y()}async function Y(){G.innerHTML='<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';try{let e="";switch(p.currentPage){case"login":J.textContent="Login / Sign Up",e='\n        <div class="max-w-md mx-auto mt-10 bg-gray-800 p-8 rounded-xl shadow-lg">\n            <img src="assets/EfficientTutor_logo.png" alt="EfficientTutor Logo" class="mx-auto h-16 w-auto mb-4">\n            <h3 id="auth-title" class="text-2xl font-bold text-center mb-6">Welcome - Log In</h3>\n            \n            <form id="auth-form" class="space-y-4">\n                \n                \x3c!-- STEP 1: Credentials --\x3e\n                <div id="step-1-container">\n                    <div id="first-name-group" class="hidden">\n                        <label for="firstName" class="block text-sm font-medium text-gray-400">First Name</label>\n                        <input type="text" id="firstName" placeholder="First Name" class="w-full mt-1 p-3 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none">\n                    </div>\n\n                    <div id="last-name-group" class="hidden">\n                        <label for="lastName" class="block text-sm font-medium text-gray-400">Last Name</label>\n                        <input type="text" id="lastName" placeholder="Last Name" class="w-full mt-1 p-3 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none">\n                    </div>\n\n                    <div id="role-group" class="hidden">\n                        <label for="role" class="block text-sm font-medium text-gray-400">I am a...</label>\n                        <select id="role" class="w-full mt-1 p-3 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none">\n                            <option value="parent" selected>Parent</option>\n                            <option value="teacher">Teacher</option>\n                        </select>\n                    </div>\n\n                    <div>\n                        <label for="email" class="block text-sm font-medium text-gray-400">Email</label>\n                        <input type="email" id="email" placeholder="Email" required class="w-full mt-1 p-3 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none">\n                    </div>\n                    <div>\n                         <label for="password" class="block text-sm font-medium text-gray-400">Password</label>\n                        <input type="password" id="password" placeholder="Password" required class="w-full mt-1 p-3 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none">\n                    </div>\n                </div>\n\n                \x3c!-- STEP 2: Teacher Specialties (Hidden by default) --\x3e\n                <div id="step-2-container" class="hidden space-y-4">\n                    <h4 class="text-lg font-semibold text-indigo-400 border-b border-gray-700 pb-2">Add Your Specialties</h4>\n                    <p class="text-sm text-gray-400">Select subjects and the grade range you teach.</p>\n                    \n                    <div class="bg-gray-700 p-3 rounded-md space-y-3">\n                        <div class="grid grid-cols-2 gap-2">\n                            <div>\n                                <label class="text-xs text-gray-400">Subject</label>\n                                <select id="specialty-subject" class="w-full p-2 bg-gray-800 rounded border border-gray-600 text-sm"></select>\n                            </div>\n                            <div>\n                                <label class="text-xs text-gray-400">System</label>\n                                <select id="specialty-system" class="w-full p-2 bg-gray-800 rounded border border-gray-600 text-sm"></select>\n                            </div>\n                        </div>\n                        <div class="flex items-center space-x-2">\n                            <div class="flex-grow">\n                                <label class="text-xs text-gray-400">Grades (1-12)</label>\n                                <div class="flex items-center space-x-2">\n                                    <input type="number" id="specialty-grade-from" min="1" max="12" placeholder="From" class="w-full p-2 bg-gray-800 rounded border border-gray-600 text-sm">\n                                    <span class="text-gray-400">-</span>\n                                    <input type="number" id="specialty-grade-to" min="1" max="12" placeholder="To" class="w-full p-2 bg-gray-800 rounded border border-gray-600 text-sm">\n                                </div>\n                            </div>\n                            <button type="button" id="add-specialty-btn" class="mt-4 bg-green-600 hover:bg-green-500 text-white p-2 rounded-md"><i class="fas fa-plus"></i></button>\n                        </div>\n                    </div>\n\n                    \x3c!-- List of Added Specialties --\x3e\n                    <div id="specialties-list" class="space-y-2 max-h-48 overflow-y-auto">\n                        \x3c!-- Dynamic items will go here --\x3e\n                        <p class="text-center text-gray-500 text-sm py-2">No specialties added yet.</p>\n                    </div>\n                </div>\n                \n                <div id="auth-feedback" class="text-center min-h-[1.5rem]"></div>\n\n                <div class="flex flex-col space-y-3 pt-2">\n                    <button type="submit" id="auth-action-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">Login</button>\n                    \n                    <button type="button" id="auth-back-btn" class="hidden w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-md transition duration-300">Back</button>\n                    \n                    <button type="button" id="auth-toggle-btn" class="w-full text-indigo-400 hover:text-indigo-300 text-sm">Need an account? Sign Up</button>\n                </div>\n            </form>\n        </div>';break;case"timetable":J.textContent="Timetable",e=await async function(){if("teacher"===p.currentUser?.role)return'<div class="text-center p-8 text-gray-400">Timetable view is not applicable for teachers. Please use the "Tuition Logs" and "Payment Logs" pages.</div>';if(!("student"===p.currentUser.role?p.currentUser.id:p.currentStudent?.id))return"parent"===p.currentUser?.role?"<div class=\"text-center p-8 text-gray-400\">No student selected. Please add or select a student from the 'Student Info' page.</div>":'<div class="text-center p-8 text-gray-400">Loading timetable...</div>';try{const e=await re();return I(!1,"parent"===p.currentUser.role?p.currentStudent:p.currentUser,"parent"===p.currentUser.role?e.filter(e=>e.student_id===p.currentStudent.id):e)}catch(e){return console.error("Error fetching timetable:",e),`<div class="text-center text-red-400 p-8">Error loading timetable: ${e.message}</div>`}}();break;case"logs":J.textContent="Logs",e=await async function(){if(!p.currentUser)return'<div class="text-center p-8 text-gray-400">You must be logged in to view logs.</div>';try{const[e,t]=await Promise.all([de(),ie()]),n=e=>e?new Date(e).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}):"",a=t.map(e=>{const t=e.attendee_names||[];return`\n                <div class="bg-gray-800 p-4 rounded-lg grid grid-cols-2 md:grid-cols-5 gap-4 items-center">\n                    <div>\n                        <p class="font-semibold">${e.subject}</p>\n                        <p class="text-sm text-indigo-300">${t.join(", ")}</p>\n                    </div>\n                    <div class="text-sm text-gray-400 text-center">\n                        <p>${new Date(e.start_time).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"})}</p>\n                        <p class="text-xs">${n(e.start_time)} - ${n(e.end_time)}</p>\n                    </div>\n                    <div class="text-center">${e.duration}</div>\n                    <div class="text-center font-semibold">${e.cost} kwd</div>\n                    <div class="text-center">\n                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${"Paid"===e.paid_status?"bg-green-500/20 text-green-400":"bg-red-500/20 text-red-400"}">\n                            ${e.paid_status}\n                        </span>\n                    </div>\n                </div>`}).join("");return`\n            <div class="space-y-6">\n                <div>\n                    <h3 class="text-xl font-semibold mb-4">Summary</h3>\n                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">\n                        <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-red-500">${e.unpaid_count}</p><p class="text-gray-400">Lessons Unpaid</p></div>\n                        <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-green-400">${e.credit_balance} kwd</p><p class="text-gray-400">Credit Balance</p></div>\n                        <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-yellow-400">${e.total_due} kwd</p><p class="text-gray-400">Total Amount Due</p></div>\n                    </div>\n                </div>\n                <div>\n                    <h3 class="text-xl font-semibold mb-4">Detailed Logs</h3>\n                    <div class="space-y-2">${a}</div>\n                </div>\n            </div>`}catch(e){return console.error("Error fetching logs:",e),`<div class="text-center text-red-400 p-8">Error loading logs: ${e.message}</div>`}}();break;case"student-info":J.textContent="Student Info",e=0===p.students.length?'\n            <div class="text-center py-12">\n                <i class="fas fa-user-graduate text-6xl text-gray-600 mb-4"></i>\n                <h3 class="text-xl font-semibold text-gray-300">No Students Yet</h3>\n                <p class="text-gray-500 mb-6">Add your children to start managing their schedule.</p>\n                <button id="btn-create-student" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-md transition duration-300">\n                    <i class="fas fa-plus mr-2"></i> Add New Student\n                </button>\n            </div>':`\n        <div class="space-y-6">\n            <div class="flex justify-between items-center">\n                <h2 class="text-2xl font-bold">My Students</h2>\n                <button id="btn-create-student" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-4 rounded-md">\n                    <i class="fas fa-plus mr-2"></i> Add New\n                </button>\n            </div>\n            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">\n                ${p.students.map(e=>`\n        <div class="bg-gray-800 p-6 rounded-lg shadow-lg hover:bg-gray-750 transition duration-300 border border-gray-700 flex flex-col">\n            <div class="flex justify-between items-start mb-4">\n                <div class="bg-indigo-900/50 p-3 rounded-full">\n                    <i class="fas fa-user-graduate text-2xl text-indigo-400"></i>\n                </div>\n                <span class="px-2 py-1 text-xs rounded-full bg-gray-700 text-gray-300 border border-gray-600">${e.status||"Active"}</span>\n            </div>\n            <h3 class="text-xl font-bold text-white mb-1">${e.first_name} ${e.last_name}</h3>\n            <p class="text-gray-400 text-sm mb-4">Grade ${e.grade}</p>\n            \n            <div class="mt-auto pt-4 border-t border-gray-700 flex justify-between items-center">\n                <span class="text-xs text-gray-500">${(e.student_subjects||[]).length} Subjects</span>\n                <button class="btn-view-student text-indigo-400 hover:text-indigo-300 text-sm font-semibold" data-id="${e.id}">\n                    Manage <i class="fas fa-arrow-right ml-1"></i>\n                </button>\n            </div>\n        </div>\n    `).join("")}\n            </div>\n        </div>`;break;case"settings":J.textContent="Settings",e=function(){const e=document.documentElement.classList.contains("dark");return`\n        <div class="max-w-2xl mx-auto space-y-6">\n            <div class="bg-gray-800 p-6 rounded-lg">\n                <h3 class="text-lg font-semibold mb-4">Appearance</h3>\n                <div class="flex items-center justify-between">\n                    <span>Theme</span>\n                    <button id="theme-toggle-btn" class="px-4 py-2 rounded-md font-semibold ${e?"bg-gray-700":"bg-gray-300 text-gray-800"}">\n                        ${e?'<i class="fas fa-moon mr-2"></i>Dark':'<i class="fas fa-sun mr-2"></i>Light'}\n                    </button>\n                </div>\n            </div>\n            <div class="bg-gray-800 p-6 rounded-lg">\n                <h3 class="text-lg font-semibold mb-4">About</h3>\n                <p class="text-gray-400">EfficientTutor ${b.version}</p>\n            </div>\n        </div>`}();break;case"notes":case"teacher-notes":J.textContent="Notes",e=await W();break;case"tuitions":J.textContent="Tuitions",e=await q();break;case"teacher-tuition-logs":J.textContent="Tuition Logs",e=await async function(){try{const[e,t]=await Promise.all([de(),ie()]);p.teacherTuitionLogs=t;const n=z(t);return`\n            <div class="space-y-6">\n                <div class="flex justify-between items-center">\n                    <h2 class="text-2xl font-bold">Tuition Logs</h2>\n                    <button id="add-new-log-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-300"><i class="fas fa-plus mr-2"></i> Add New Log</button>\n                </div>\n                <div>\n                    <h3 class="text-xl font-semibold mb-4">Summary</h3>\n                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">\n                        <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-blue-400">${e.total_lessons_given_this_month}</p><p class="text-gray-400">Lessons This Month</p></div>\n                        <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-green-400">${e.total_credit_held} kwd</p><p class="text-gray-400">Total Credit Held</p></div>\n                        <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-yellow-400">${e.total_owed_to_teacher} kwd</p><p class="text-gray-400">Total Owed to You</p></div>\n                    </div>\n                </div>\n                ${n}\n            </div>`}catch(e){return console.error("Error rendering tuition logs page:",e),`<div class="text-center text-red-400 p-8">Error loading tuition logs: ${e.message}</div>`}}();break;case"teacher-payment-logs":case"teacher-payment-logs":J.textContent="Payment Logs",e=await H();break;case"teacher-timetables":J.textContent="Timetables",e='<div class="p-8 text-center text-gray-400">The Timetables feature for teachers is not yet implemented.</div>';break;case"teacher-student-info":J.textContent="Student Info",e=await async function(){try{$("Loading Students...");const e=await ne();return S(),0===e.length?'<div class="text-center text-gray-400 p-8">You have no students assigned yet.</div>':`\n            <div class="space-y-6">\n                <div class="flex justify-between items-center">\n                    <h2 class="text-2xl font-bold">Student Information</h2>\n                </div>\n                <div class="bg-gray-800 p-4 rounded-lg">\n                    <label class="block text-sm font-medium text-gray-400 mb-2">Select Student to Manage</label>\n                    <select id="teacher-student-selector" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none">\n                        <option value="">-- Select a Student --</option>\n                        ${e.map(e=>`<option value="${e.id}">${e.first_name} ${e.last_name} (Grade ${e.grade})</option>`).join("")}\n                    </select>\n                </div>\n                <div id="teacher-student-profile-container">\n                    <div class="text-center text-gray-500 py-8">Select a student above to view and edit their details.</div>\n                </div>\n            </div>\n        `}catch(e){return console.error("Error rendering teacher student info page:",e),`<div class="text-center text-red-400 p-8">Error loading student information: ${e.message}</div>`}}();break;case"profile":J.textContent="Profile",e=await A();break;default:J.textContent="Not Found",e="<p>Page not found.</p>"}G.innerHTML=e}catch(e){console.error("Failed to render page:",e),L(`Error loading page: ${e.message}`)}}async function K(){if(localStorage.getItem("accessToken"))try{const e=await te();p.currentUser=e,D(e.role),document.getElementById("user-info").classList.remove("hidden"),document.getElementById("logout-button").classList.remove("hidden"),document.getElementById("user-email").textContent=e.email,"parent"===e.role?(await async function(){try{const e=await ne();p.students=e,p.currentStudent=e[0]||null}catch(e){console.error("Error loading parent students:",e)}}(),0===p.students.length?V("student-info"):V("timetable")):"student"===e.role?(await async function(){}(),V("timetable")):"teacher"===e.role&&V("teacher-tuition-logs")}catch(e){console.error("Failed to fetch user with token:",e),X(),_("Your session may have expired. Please log in again.")}else D(null),p.currentUser=null,p.students=[],p.currentStudent=null,document.getElementById("user-info").classList.add("hidden"),document.getElementById("logout-button").classList.add("hidden"),V("login")}async function Z(e,t){$("Logging in...");try{const n=await async function(e,t){const n={username:e,password:t},a=Object.keys(n).map(e=>encodeURIComponent(e)+"="+encodeURIComponent(n[e])).join("&"),s=await fetch(`${b.backendUrl}/auth/login`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:a}),r=await s.json();if(!s.ok){if(400===s.status)throw new Error("Incorrect email or password.");const e=r.detail&&Array.isArray(r.detail)?r.detail.map(e=>e.msg).join(", "):r.detail||`HTTP error! status: ${s.status}`;throw new Error(e)}return r}(e,t);localStorage.setItem("accessToken",n.access_token),await K()}catch(n){_(n.message)}finally{S()}}function X(){localStorage.removeItem("accessToken"),p.currentUser=null,p.students=[],p.currentStudent=null,document.getElementById("user-info").classList.add("hidden"),document.getElementById("logout-button").classList.add("hidden"),D(null),V("login")}async function Q(e,t={}){const n=localStorage.getItem("accessToken"),a={"Content-Type":"application/json",...t.headers};n&&(a.Authorization=`Bearer ${n}`);const s={...t,headers:a};try{const t=await fetch(`${b.backendUrl}${e}`,s);if(204===t.status)return null;const n=await t.json();if(!t.ok){if(401===t.status)return S(),X(),new Promise(()=>{});let e=`HTTP error! status: ${t.status}`;throw n&&n.detail&&(e=Array.isArray(n.detail)?n.detail.map(e=>`${e.loc.join(" -> ")}: ${e.msg}`).join("; "):n.detail),new Error(e)}return n}catch(r){throw console.error("API Request Error:",r),r}}const ee=(e,t,n,a,s,r=[])=>{const i="parent"===s?"/auth/signup/parent":"/auth/signup/teacher",o={email:e,password:t,first_name:n,last_name:a};return"teacher"===s&&(o.teacher_specialties=r),Q(i,{method:"POST",body:JSON.stringify(o)})},te=()=>Q("/users/me"),ne=()=>Q("/students/"),ae=e=>Q(`/students/${e}`),se=(e,t)=>{const n={...t,parent_id:e};return Q("/students/",{method:"POST",body:JSON.stringify(n)})},re=()=>Q("/timetable/"),ie=()=>Q("/tuition-logs/"),oe=()=>Q("/payment-logs/"),de=()=>Q("/financial-summary/"),le=()=>Q("/tuitions/"),ce=()=>Q("/tuitions/"),ue=e=>Q("/tuition-logs",{method:"POST",body:JSON.stringify(e)}),me=e=>Q(`/tuition-logs/${e}/void`,{method:"PATCH"}),ge=(e,t)=>Q(`/tuition-logs/${e}/correction`,{method:"POST",body:JSON.stringify(t)}),be=()=>Q("/parents/"),pe=e=>Q("/payment-logs",{method:"POST",body:JSON.stringify(e)}),ye=e=>Q(`/payment-logs/${e}/void`,{method:"PATCH"}),ve=(e,t)=>Q(`/payment-logs/${e}/correction`,{method:"POST",body:JSON.stringify(t)}),fe=(e,t,n)=>{const a={meeting_link_type:"GOOGLE_MEET",meeting_link:e,meeting_password:t||null,meeting_id:n||null};if(!a.meeting_id)try{const t=new URL(e);"meet.google.com"===t.hostname&&(a.meeting_id=t.pathname.substring(1))}catch(s){}return a},he=(e,t,n,a)=>Q(`/tuitions/${e}/meeting_link`,{method:"POST",body:JSON.stringify(fe(t,n,a))}),xe=(e,t,n,a)=>Q(`/tuitions/${e}/meeting_link`,{method:"PATCH",body:JSON.stringify(fe(t,n,a))}),we=e=>Q(`/tuitions/${e}/meeting_link`,{method:"DELETE"}),$e=()=>Q("/notes/"),ke=e=>Q("/notes/",{method:"POST",body:JSON.stringify(e)}),Se=(e,t)=>Q(`/notes/${e}`,{method:"PATCH",body:JSON.stringify(t)}),_e=e=>Q(`/teachers/${e}`),je=e=>Q(`/parents/${e}`),Ee=(e,t)=>Q(`/students/${e}`,{method:"PATCH",body:JSON.stringify(t)}),Le=async()=>Promise.resolve(["UTC","Asia/Kuwait","Asia/Riyadh","Asia/Dubai","Europe/London","America/New_York"]),Ie=async()=>Promise.resolve(["KWD","USD","EUR","GBP","SAR","AED"]),Te=e=>Q(`/teachers/${e}/specialties`),Ne=(e,t,n)=>{const a={subject:e,educational_system:t};return n&&(a.grade=n),Q(`/teachers/by_specialty?${new URLSearchParams(a).toString()}`)};function Pe(e,t,n){if(1===e){const e=n.querySelector("#firstName").value.trim(),a=n.querySelector("#lastName").value.trim(),s=n.querySelector("#grade").value.trim();if(!e||!a||!s)return y("Validation Error","<p>Please fill in all fields.</p>",'<div class="flex justify-end"><button id="modal-close-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">OK</button></div>'),!1;t.firstName=e,t.lastName=a,t.grade=s}return!0}function Ce(e=null,t){let n=1,a=e?JSON.parse(JSON.stringify(e)):{id:([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)),subjects:[],availability:{}};if(!e){const e=["Sunday","Monday","Tuesday","Wednesday","Thursday"];b.daysOfWeek.forEach(t=>{const n=t.toLowerCase();a.availability[n]=[],a.availability[n].push({type:"sleep",...b.defaultSleepTimes}),e.includes(t)&&a.availability[n].push({type:"school",...b.defaultSchoolTimes})})}const s=()=>{let e="",t="";switch(n){case 1:e=`\n        <div class="space-y-4">\n            <input type="text" id="firstName" placeholder="First Name" value="${(s=a).firstName||""}" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600">\n            <input type="text" id="lastName" placeholder="Last Name" value="${s.lastName||""}" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600">\n            <input type="text" id="grade" placeholder="Grade (e.g., 10)" value="${s.grade||""}" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600">\n        </div>`,t='<div class="flex justify-end"><button id="wizard-next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Next</button></div>';break;case 2:e=function(e){const t=b.subjects.map(e=>`<option value="${e}">${e}</option>`).join(""),n=p.students.filter(t=>t.id!==e.id);return`\n        <div id="registered-subjects-list" class="space-y-2 mb-4">${e.subjects.map((e,t)=>{const a=e.sharedWith.map(e=>{const t=p.students.find(t=>t.id===e);return t?t.firstName:""}).filter(Boolean).join(", "),s=n.length>0?n.map(n=>`\n            <label class="flex items-center space-x-2 p-1 hover:bg-gray-600 rounded-md">\n                <input type="checkbox" class="share-checkbox" data-subject-index="${t}" data-student-id="${n.id}" ${e.sharedWith.includes(n.id)?"checked":""}>\n                <span>${n.firstName} ${n.lastName}</span>\n            </label>`).join(""):'<div class="px-2 py-1 text-sm text-gray-400">No other students to share with.</div>';return`\n            <div class="bg-gray-700 p-2 rounded-md">\n                <div class="flex justify-between items-center">\n                    <div>\n                        <p>${e.name} - ${e.lessonsPerWeek} lessons/week</p>\n                        ${a?`<p class="text-xs text-indigo-300">Shared with: ${a}</p>`:""}\n                    </div>\n                    <div class="flex items-center space-x-2">\n                        <div class="relative share-container">\n                            <button class="share-btn p-2 text-sm bg-indigo-600 hover:bg-indigo-700 rounded-md"><i class="fas fa-users mr-1"></i> Allowed Others</button>\n                            <div class="share-dropdown hidden absolute right-0 mt-1 w-48">${s}</div>\n                        </div>\n                        <button class="remove-subject-btn text-red-400 hover:text-red-300" data-index="${t}"><i class="fas fa-times-circle"></i></button>\n                    </div>\n                </div>\n            </div>`}).join("")||'<p class="text-sm text-gray-400">No subjects added yet.</p>'}</div>\n        <div class="flex space-x-2">\n            <select id="subject-select" class="flex-grow p-2 bg-gray-700 rounded-md border border-gray-600">${t}</select>\n            <input type="number" id="lessons-per-week" placeholder="Lessons/wk" min="1" value="1" class="w-28 p-2 bg-gray-700 rounded-md border border-gray-600">\n            <button id="add-subject-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-md"><i class="fas fa-plus"></i> Add</button>\n        </div>`}(a),t='<div class="flex justify-between"><button id="wizard-prev-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Back</button><button id="wizard-next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Next</button></div>';break;case 3:e=function(e){return`<div id="wizard-timetable-container">${I(!0,e)}</div>`}(a),t='<div class="flex justify-between"><button id="wizard-prev-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Back</button><button id="wizard-next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Next</button></div>';break;case 4:e='\n        <div class="text-center py-8">\n            <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>\n            <h3 class="text-2xl font-semibold">All Set!</h3>\n            <p class="text-gray-400 mt-2">All student information has been entered. Click Finish to save.</p>\n        </div>',t='<div class="flex justify-between"><button id="wizard-prev-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Back</button><button id="wizard-finish-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-md">Finish</button></div>'}var s;y(`Student Registration - Step ${n} of 4`,e,t,e=>r(e,a))},r=(e,a)=>{e.addEventListener("click",async r=>{const i=r.target,o=e=>i.closest(e);if(o("#wizard-next-btn")?Pe(n,a,e)&&(n++,s()):o("#wizard-prev-btn")?(n--,s()):o("#wizard-finish-btn")&&await t(a),2===n){if(o("#add-subject-btn")){const t=e.querySelector("#subject-select").value,n=parseInt(e.querySelector("#lessons-per-week").value);n>0&&!a.subjects.find(e=>e.name===t)&&(a.subjects.push({name:t,lessonsPerWeek:n,sharedWith:[]}),s())}const t=o(".remove-subject-btn");t&&(a.subjects.splice(parseInt(t.dataset.index),1),s());const n=o(".share-btn");if(n){const e=n.nextElementSibling,t=e.classList.contains("hidden");document.querySelectorAll(".share-dropdown").forEach(e=>e.classList.add("hidden")),t&&e.classList.remove("hidden")}}if(3===n){const t=o(".day-nav-btn");t&&(p.currentTimetableDay=(p.currentTimetableDay+parseInt(t.dataset.direction)+7)%7,s());const n=()=>{const t=e.querySelector("#wizard-timetable-container");t&&(t.innerHTML=I(!0,a))},i=o("#timetable-grid-main");i&&r.target===i&&T.showAddEventModal(a,i.dataset.dayKey,r.offsetY,n);const d=o(".event-bubble");d&&"tuition"!==d.dataset.type&&T.showEditEventModal(a,i.dataset.dayKey,d.dataset.start,n);const l=o(".set-all-times-btn");if(l){const e=l.dataset.type;T.showSetAllTimesModal(a,e,n)}}}),e.addEventListener("change",e=>{const t=e.target,n=(r=".share-checkbox",t.closest(r));var r;if(n){const e=parseInt(n.dataset.subjectIndex),t=n.dataset.studentId,r=a.subjects[e].sharedWith;if(n.checked)r.includes(t)||r.push(t);else{const e=r.indexOf(t);e>-1&&r.splice(e,1)}s()}})};s()}const Ae=o("App",{web:()=>function(e){function t(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return Promise.resolve().then(n=>{for(const e of n||[])"rejected"===e.status&&t(e.reason);return e().catch(t)})}(()=>t.import("./web-legacy-BFeBl7E8.js")).then(e=>new e.AppWeb)}),Ue=o("PushNotifications",{});let Be=[];async function Oe(e){if(p.currentUser){$("Saving student data...");try{await se(p.currentUser.id,e),await K(),h(),k("success","Student saved successfully!"),V("student-info")}catch(t){console.error("Error saving student:",t),k("error",t.message)}}}async function De(e){if(p.currentUser){$("Deleting student...");try{await(e=>Q(`/students/${e}`,{method:"DELETE"}))(e),await K(),k("success","Student deleted."),Y()}catch(t){console.error("Error deleting student:",t),k("error",t.message)}}}async function qe(e){const t=document.getElementById("profile-first-name").value.trim(),n=document.getElementById("profile-last-name").value.trim(),a=document.getElementById("profile-email").value.trim(),s=document.getElementById("profile-timezone").value,r=document.getElementById("profile-currency").value;if(!t||!n||!a)return void k("error","Name and Email are required.");const i={first_name:t,last_name:n,email:a,timezone:s||null,currency:r||null};$("Updating Profile...");try{await(o=e,d=i,Q(`/teachers/${o}`,{method:"PATCH",body:JSON.stringify(d)})),p.currentUser&&p.currentUser.id===e&&(p.currentUser.first_name=t,p.currentUser.last_name=n,p.currentUser.email=a),k("success","Profile updated successfully."),Y()}catch(l){console.error("Profile update error:",l),k("error",l.message)}var o,d}async function Me(e){const t=document.getElementById("profile-first-name").value.trim(),n=document.getElementById("profile-last-name").value.trim(),a=document.getElementById("profile-email").value.trim(),s=document.getElementById("profile-timezone").value,r=document.getElementById("profile-currency").value;if(!t||!n||!a)return void k("error","Name and Email are required.");const i={first_name:t,last_name:n,email:a,timezone:s||null,currency:r||null};$("Updating Profile...");try{await(o=e,d=i,Q(`/parents/${o}`,{method:"PATCH",body:JSON.stringify(d)})),p.currentUser&&p.currentUser.id===e&&(p.currentUser.first_name=t,p.currentUser.last_name=n,p.currentUser.email=a),k("success","Profile updated successfully."),Y()}catch(l){console.error("Parent profile update error:",l),k("error",l.message)}var o,d}function ze(e){y("Add Specialty",`\n        <div class="space-y-4">\n            <div class="grid grid-cols-2 gap-4">\n                <div>\n                    <label class="text-sm text-gray-400">Subject</label>\n                    <select id="new-specialty-subject" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                        ${b.noteSubjects.map(e=>`<option value="${e}">${e}</option>`).join("")}\n                    </select>\n                </div>\n                <div>\n                    <label class="text-sm text-gray-400">System</label>\n                    <select id="new-specialty-system" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n                        ${b.educationalSystems.map(e=>`<option value="${e}">${e}</option>`).join("")}\n                    </select>\n                </div>\n            </div>\n            <div>\n                <label class="text-sm text-gray-400">Grade</label>\n                <input type="number" id="new-specialty-grade" min="1" max="12" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600" placeholder="1-12">\n            </div>\n        </div>\n    `,'<div class="flex justify-end"><button id="submit-new-specialty-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Add Specialty</button></div>',t=>{t.querySelector("#submit-new-specialty-btn").addEventListener("click",async()=>{const n=t.querySelector("#new-specialty-subject").value,a=t.querySelector("#new-specialty-system").value,s=parseInt(t.querySelector("#new-specialty-grade").value);if(!n||!a||isNaN(s)||s<1||s>12)alert("Please enter valid subject, system, and grade (1-12).");else{$("Adding specialty...");try{await((e,t)=>Q(`/teachers/${e}/specialties`,{method:"POST",body:JSON.stringify(t)}))(e,{subject:n,educational_system:a,grade:s}),h(),k("success","Specialty added."),Y()}catch(r){k("error",r.message)}}})})}function Fe(e=!1){j();const t=document.getElementById("email").value.trim(),n=document.getElementById("password").value;let a=null,s=null,r=null;return!e||(a=document.getElementById("firstName").value.trim(),s=document.getElementById("lastName").value.trim(),r=document.getElementById("role").value,a&&s)?t&&n?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)?n.length<6?(_("Password must be at least 6 characters long."),null):{email:t,password:n,firstName:a,lastName:s,role:r}:(_("Please enter a valid email address."),null):(_("Email and password cannot be empty."),null):(_("First name and last name cannot be empty for signup."),null)}function He(){const e=document.getElementById("role").value,t=document.getElementById("auth-action-btn"),n="signup"===t.dataset.mode,a=!document.getElementById("step-2-container").classList.contains("hidden");n&&"teacher"===e&&!a?t.textContent="Next":n&&(t.textContent="Sign Up")}function Re(){const e=document.getElementById("specialties-list");if(0===Be.length)return void(e.innerHTML='<p class="text-center text-gray-500 text-sm py-2">No specialties added yet.</p>');const t=Be.map((e,t)=>`\n        <div class="flex justify-between items-center bg-gray-800 p-2 rounded text-sm border border-gray-600">\n            <span><span class="font-bold text-indigo-400">${e.subject}</span> <span class="text-xs text-gray-400">(${e.educational_system})</span> Grade ${e.grade}</span>\n            <button type="button" class="remove-specialty-btn text-red-400 hover:text-red-300" data-index="${t}"><i class="fas fa-times"></i></button>\n        </div>\n    `).join("");e.innerHTML=t}document.body.addEventListener("click",e=>{const t=e.target,n=e=>t.closest(e);n(".share-container")||document.querySelectorAll(".share-dropdown").forEach(e=>e.classList.add("hidden")),n("#menu-button")&&E(),(n("#modal-close-btn")||n("#modal-backdrop")&&!n(".modal-content"))&&h(),n("#theme-toggle-btn")&&(document.documentElement.classList.toggle("dark"),document.documentElement.classList.toggle("light"),Y());const a=n(".nav-link");if(a&&(e.preventDefault(),V(a.id.replace("nav-",""))),n("#auth-action-btn")){e.preventDefault();const n=t.dataset.mode||"login",a=document.getElementById("role").value,s=document.getElementById("step-1-container"),r=document.getElementById("step-2-container"),i=document.getElementById("auth-back-btn");if(document.getElementById("auth-action-btn"),"signup"===n&&"teacher"===a&&r.classList.contains("hidden"))Fe(!0)&&(s.classList.add("hidden"),r.classList.remove("hidden"),i.classList.remove("hidden"),function(){const e=document.getElementById("specialty-subject"),t=document.getElementById("specialty-system");0===e.options.length&&(e.innerHTML=b.noteSubjects.map(e=>`<option value="${e}">${e}</option>`).join("")),0===t.options.length&&(t.innerHTML=b.educationalSystems.map(e=>`<option value="${e}">${e}</option>`).join(""))}(),He());else{const e=Fe("signup"===n);if(e)if("signup"===n){if("teacher"===a&&(e.teacher_specialties=Be,0===Be.length))return void _("Please add at least one specialty.","error");!async function(e,t,n,a,s,r=[]){$("Signing up...");try{await ee(e,t,n,a,s,r),S(),_("Signup successful! Please log in with your new account.","success")}catch(i){S(),_(i.message)}}(e.email,e.password,e.firstName,e.lastName,e.role,e.teacher_specialties)}else Z(e.email,e.password)}}if(n("#auth-back-btn")&&(document.getElementById("step-1-container").classList.remove("hidden"),document.getElementById("step-2-container").classList.add("hidden"),document.getElementById("auth-back-btn").classList.add("hidden"),He()),n("#add-specialty-btn")){const e=document.getElementById("specialty-subject").value,t=document.getElementById("specialty-system").value,n=parseInt(document.getElementById("specialty-grade-from").value),a=parseInt(document.getElementById("specialty-grade-to").value);if(!e||!t||isNaN(n)||isNaN(a))return;if(n<1||a>12||n>a)return void alert("Invalid grade range (1-12).");for(let s=n;s<=a;s++)Be.some(n=>n.subject===e&&n.educational_system===t&&n.grade===s)||Be.push({subject:e,educational_system:t,grade:s});Re(),document.getElementById("specialty-grade-from").value="",document.getElementById("specialty-grade-to").value=""}const s=n(".remove-specialty-btn");if(s){const e=parseInt(s.dataset.index);Be.splice(e,1),Re()}n("#auth-toggle-btn")&&(e.preventDefault(),function(e){j();const t=document.getElementById("auth-title"),n=document.getElementById("first-name-group"),a=document.getElementById("last-name-group"),s=document.getElementById("role-group"),r=document.getElementById("auth-action-btn"),i=document.getElementById("auth-toggle-btn");document.getElementById("step-1-container").classList.remove("hidden"),document.getElementById("step-2-container").classList.add("hidden"),document.getElementById("auth-back-btn").classList.add("hidden"),Be=[],Re(),e?(t.textContent="Create Account - Sign Up",n.classList.remove("hidden"),a.classList.remove("hidden"),s.classList.remove("hidden"),r.textContent="Sign Up",i.textContent="Already have an account? Log In",r.dataset.mode="signup",He()):(t.textContent="Welcome - Log In",n.classList.add("hidden"),a.classList.add("hidden"),s.classList.add("hidden"),r.textContent="Login",i.textContent="Need an account? Sign Up",r.dataset.mode="login")}("login"===(document.getElementById("auth-action-btn").dataset.mode||"login"))),n("#logout-button")&&X(),n("#add-new-student-btn")&&Ce(null,Oe);const r=n(".edit-student-btn");if(r){const e=p.students.find(e=>e.id===r.dataset.id);e&&Ce(e,Oe)}const i=n(".delete-student-btn");if(i){const e=p.students.find(e=>e.id===i.dataset.id);e&&function(e,t){y("Confirm Deletion",`<p>Are you sure you want to delete ${e.firstName}?</p>`,'\n        <div class="flex justify-end space-x-4">\n            <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button>\n            <button id="modal-confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-md">Delete</button>\n        </div>',n=>{n.addEventListener("click",n=>{n.target.closest("#modal-confirm-delete-btn")&&(t(e.id),h()),n.target.closest("#modal-cancel-btn")&&h()})})}(e,De)}const o=n(".view-creds-btn");o&&async function(e){$("Fetching credentials...");try{const t=await ae(e);y("Student Credentials",`\n            <div class="space-y-4">\n                <div>\n                    <label class="text-sm font-medium text-gray-400">Email</label>\n                    <input type="text" readonly value="${t.email}" class="w-full mt-1 p-2 bg-gray-800 rounded-md border border-gray-600">\n                </div>\n                <div>\n                    <label class="text-sm font-medium text-gray-400">Password</label>\n                    <input type="text" readonly value="${t.generated_password}" class="w-full mt-1 p-2 bg-gray-800 rounded-md border border-gray-600">\n                </div>\n                <p class="text-xs text-gray-500">Please save this password in a secure location.</p>\n            </div>\n        `,'<div class="flex justify-end"><button id="modal-close-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Close</button></div>')}catch(t){k("error",t.message)}finally{S()}}(o.dataset.id),n("#add-new-log-btn")&&F();const d=n(".void-log-btn");var l;d&&(l=d.dataset.logId,y("Confirm Void","<p>Are you sure you want to void this log? This action cannot be undone.</p>",'<div class="flex justify-end space-x-4"><button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button><button id="modal-confirm-void-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-md">Void Log</button></div>',e=>{e.querySelector("#modal-confirm-void-btn").addEventListener("click",async()=>{$("Voiding log...");try{await me(l),h(),k("success","Log voided successfully."),Y()}catch(e){k("error",e.message)}})}));const c=n(".correct-log-btn");if(c){const e=c.dataset.logId,t=p.teacherTuitionLogs?.find(t=>t.id===e);t&&F(t)}const u=n(".view-charges-btn");u&&function(e){const t=p.teacherTuitionLogs?.find(t=>t.id===e);t&&t.charges?y("Cost Breakdown",`<ul class="space-y-2">${t.charges.map(e=>`<li class="flex justify-between items-center p-2 bg-gray-700 rounded-md"><span>${e.student_name}</span><span class="font-semibold">${e.cost} kwd</span></li>`).join("")}</ul>`,'<div class="flex justify-end"><button id="modal-close-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Close</button></div>'):k("error","Charge details not available.")}(u.dataset.logId),n("#add-new-payment-log-btn")&&R();const m=n(".void-payment-log-btn");m&&function(e){y("Confirm Void","<p>Are you sure you want to void this payment log? This action cannot be undone.</p>",'<div class="flex justify-end space-x-4"><button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button><button id="modal-confirm-void-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-md">Void Log</button></div>',t=>{t.querySelector("#modal-confirm-void-btn").addEventListener("click",async()=>{$("Voiding payment...");try{await ye(e),h(),k("success","Payment log voided."),Y()}catch(t){k("error",t.message)}})})}(m.dataset.logId);const g=n(".correct-payment-log-btn");if(g){const e=g.dataset.logId,t=p.teacherPaymentLogs?.find(t=>t.id===e);t&&R(t)}const v=n(".view-meeting-link-btn");if(v){const e=v.dataset.tuitionId,t=(p.teacherScheduledTuitions||[]).find(t=>t.tuition.id===e);t&&t.tuition&&function(e){const t=e.meeting_link;t?y("Meeting Link Details",`\n        <div class="space-y-3 text-sm">\n            <div><label class="text-xs text-gray-400">Subject</label><p class="font-semibold text-base">${e.subject}</p></div>\n            <div class="border-t border-gray-700 pt-3"><label class="text-xs text-gray-400">URL</label><a href="${t.meeting_link}" target="_blank" rel="noopener noreferrer" class="block break-all text-blue-400 hover:underline">${t.meeting_link}</a></div>\n            <div><label class="text-xs text-gray-400">Meeting ID</label><p class="font-mono">${t.meeting_id||"None"}</p></div>\n            <div><label class="text-xs text-gray-400">Password</label><p class="font-mono">${t.meeting_password||"None"}</p></div>\n        </div>`,'\n        <div class="flex justify-end w-full">\n            <button id="modal-close-btn" class="p-2 px-4 text-sm bg-gray-600 hover:bg-gray-500 rounded-md">Close</button>\n        </div>'):k("info","No meeting link is set for this tuition.")}(t.tuition)}const x=n(".edit-meeting-link-btn");if(x){const e=x.dataset.tuitionId,t=(p.teacherScheduledTuitions||[]).find(t=>t.tuition.id===e);t&&function(e){const t=e.meeting_link,n=t?t.meeting_link:"",a=t?t.meeting_password:"";y("Add/Edit Meeting Link",`\n        <div class="space-y-4">\n            <div>\n                <label for="meeting-url" class="block text-sm font-medium text-gray-400">Meeting URL</label>\n                <input type="text" id="meeting-url" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600" value="${n||""}" placeholder="https://meet.google.com/abc-def-ghi">\n            </div>\n            <div>\n                <label for="meeting-id" class="block text-sm font-medium text-gray-400">Meeting ID (optional)</label>\n                <input type="text" id="meeting-id" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600" value="${(t?t.meeting_id:"")||""}" placeholder="abc-def-ghi">\n                <p class="text-xs text-gray-500 mt-1">If left empty, will be auto-detected from Google Meet URLs.</p>\n            </div>\n            <div>\n                <label for="meeting-password" class="block text-sm font-medium text-gray-400">Password (optional)</label>\n                <input type="text" id="meeting-password" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600" value="${a||""}">\n            </div>\n        </div>`,`\n        <div class="flex justify-between items-center w-full">\n            ${t?`<button title="Delete Link" class="delete-meeting-link-btn p-2 px-4 text-sm bg-red-600 hover:bg-red-500 rounded-md" data-tuition-id="${e.id}"><i class="fas fa-trash"></i> Delete</button>`:""}\n            <div class="flex-grow flex justify-end space-x-4">\n                 <button id="modal-close-btn" class="p-2 px-4 text-sm bg-gray-600 hover:bg-gray-500 rounded-md">Cancel</button>\n                 <button id="submit-meeting-link-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Save</button>\n            </div>\n        </div>`,n=>{n.querySelector("#submit-meeting-link-btn").addEventListener("click",async()=>{const a=n.querySelector("#meeting-url").value.trim(),s=n.querySelector("#meeting-password").value.trim(),r=n.querySelector("#meeting-id").value.trim();if(a)if(/^(https?:\/\/)?([\w\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(a)){$("Saving link...");try{t?await xe(e.id,a,s,r):await he(e.id,a,s,r),h(),k("success","Meeting link saved."),Y()}catch(i){i.message.includes("Input should be a valid URL")?k("error","The provided URL is not valid. Please check and try again."):k("error",`Failed to save link: ${i.message}`)}}else k("error","Please enter a valid URL format.");else if(t){$("Deleting link...");try{await we(e.id),h(),k("success","Meeting link deleted."),Y()}catch(i){k("error",`Failed to delete link: ${i.message}`)}}else h()})})}(t.tuition)}const w=n(".delete-meeting-link-btn");if(w){const e=w.dataset.tuitionId;f("Delete Meeting Link","Are you sure you want to delete the meeting link for this tuition?",()=>{$("Deleting link..."),we(e).then(()=>{k("success","Meeting link deleted."),Y()}).catch(e=>{k("error",`Failed to delete link: ${e.message}`)}).finally(()=>{h()})})}n("#add-new-note-btn")&&y("Add New Note",`\n        <div class="space-y-4">\n            <div>\n                <label for="note-student-id" class="block text-sm font-medium text-gray-400">Student</label>\n                <select id="note-student-id" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">${p.allStudents.map(e=>`<option value="${e.id}">${e.first_name} ${e.last_name}</option>`).join("")}</select>\n            </div>\n            <div class="grid grid-cols-2 gap-4">\n                <div>\n                    <label for="note-subject" class="block text-sm font-medium text-gray-400">Subject</label>\n                    <select id="note-subject" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">${b.noteSubjects.map(e=>`<option value="${e}">${e}</option>`).join("")}</select>\n                </div>\n                <div>\n                    <label for="note-type" class="block text-sm font-medium text-gray-400">Note Type</label>\n                    <select id="note-type" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">${b.noteTypes.map(e=>`<option value="${e}">${e.replace(/_/g," ")}</option>`).join("")}</select>\n                </div>\n            </div>\n            <div>\n                <label for="note-name" class="block text-sm font-medium text-gray-400">Note Name</label>\n                <input type="text" id="note-name" placeholder="e.g., Algebra Chapter 5 Review" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n            </div>\n            <div>\n                <label for="note-description" class="block text-sm font-medium text-gray-400">Description</label>\n                <textarea id="note-description" rows="3" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></textarea>\n            </div>\n            <div>\n                <label for="note-url" class="block text-sm font-medium text-gray-400">URL</label>\n                <input type="url" id="note-url" placeholder="https://example.com/document.pdf" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n            </div>\n        </div>\n    `,'<div class="flex justify-end"><button id="submit-note-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Create Note</button></div>',e=>{p.notesStudentFilter&&(e.querySelector("#note-student-id").value=p.notesStudentFilter),e.querySelector("#submit-note-btn").addEventListener("click",async()=>{const t={student_id:e.querySelector("#note-student-id").value,subject:e.querySelector("#note-subject").value,note_type:e.querySelector("#note-type").value,name:e.querySelector("#note-name").value.trim(),description:e.querySelector("#note-description").value.trim(),url:e.querySelector("#note-url").value.trim()};if(t.student_id&&t.name){$("Creating note...");try{await ke(t),h(),k("success","Note created successfully."),await Y()}catch(n){k("error",`Failed to create note: ${n.message}`)}}else k("error","Student and Note Name are required.")})});const L=n(".edit-note-btn");if(L){const e=p.notes.find(e=>e.id===L.dataset.noteId);e&&function(e){const t=b.noteSubjects.map(t=>`<option value="${t}" ${e.subject===t?"selected":""}>${t}</option>`).join(""),n=b.noteTypes.map(t=>`<option value="${t}" ${e.note_type===t?"selected":""}>${t.replace(/_/g," ")}</option>`).join("");y("Edit Note",`\n        <div class="space-y-4">\n             <p class="text-sm text-gray-400">Student: <span class="font-semibold">${e.student.first_name} ${e.student.last_name}</span></p>\n            <div class="grid grid-cols-2 gap-4">\n                <div>\n                    <label for="note-subject" class="block text-sm font-medium text-gray-400">Subject</label>\n                    <select id="note-subject" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">${t}</select>\n                </div>\n                <div>\n                    <label for="note-type" class="block text-sm font-medium text-gray-400">Note Type</label>\n                    <select id="note-type" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">${n}</select>\n                </div>\n            </div>\n            <div>\n                <label for="note-name" class="block text-sm font-medium text-gray-400">Note Name</label>\n                <input type="text" id="note-name" value="${e.name}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n            </div>\n            <div>\n                <label for="note-description" class="block text-sm font-medium text-gray-400">Description</label>\n                <textarea id="note-description" rows="3" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">${e.description||""}</textarea>\n            </div>\n            <div>\n                <label for="note-url" class="block text-sm font-medium text-gray-400">URL</label>\n                <input type="url" id="note-url" value="${e.url||""}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n            </div>\n        </div>\n    `,'<div class="flex justify-end"><button id="submit-update-note-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Save Changes</button></div>',t=>{t.querySelector("#submit-update-note-btn").addEventListener("click",async()=>{const n={subject:t.querySelector("#note-subject").value,note_type:t.querySelector("#note-type").value,name:t.querySelector("#note-name").value.trim(),description:t.querySelector("#note-description").value.trim(),url:t.querySelector("#note-url").value.trim()};if(n.name){$("Updating note...");try{await Se(e.id,n),h(),k("success","Note updated successfully."),await Y()}catch(a){k("error",`Failed to update note: ${a.message}`)}}else k("error","Note Name is required.")})})}(e)}const I=n(".delete-note-btn");if(I){const e=I.dataset.noteId,t=p.notes.find(t=>t.id===e);f("Delete Note",`Are you sure you want to delete ${t?`"${t.name}"`:"this note"}?`,()=>{$("Deleting note..."),(e=>Q(`/notes/${e}`,{method:"DELETE"}))(e).then(()=>{k("success","Note deleted."),Y()}).catch(e=>k("error",`Failed to delete note: ${e.message}`))})}const T=n(".subject-card-button");if(T){const e=T.dataset.subject;document.getElementById("notes-content-container").innerHTML=function(e){const t=p.notes.filter(t=>t.student.id===p.notesStudentFilter&&t.subject===e);if(0===t.length)return'<p class="text-gray-400">No notes found for this subject.</p>';const n=t.reduce((e,t)=>{const n=t.note_type;return e[n]||(e[n]=[]),e[n].push(t),e},{}),a="teacher"===p.currentUser?.role,s=Object.entries(n).map(([e,t])=>`\n            <div class="mb-6">\n                <h3 class="text-lg font-semibold text-gray-300 mb-3">${e.replace(/_/g," ").replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())}</h3>\n                <div class="space-y-3">\n                    ${t.map(e=>{const t=a?`\n                <div class="flex-shrink-0 space-x-2">\n                    <button title="Edit Note" class="edit-note-btn p-2 text-sm bg-gray-600 hover:bg-gray-500 rounded-md" data-note-id="${e.id}"><i class="fas fa-edit"></i></button>\n                    <button title="Delete Note" class="delete-note-btn p-2 text-sm bg-red-600 hover:bg-red-500 rounded-md" data-note-id="${e.id}"><i class="fas fa-trash"></i></button>\n                </div>\n            `:"";return`\n                <div class="bg-gray-800 p-4 rounded-lg flex items-start justify-between gap-4">\n                    <div class="flex-grow">\n                        <h4 class="font-semibold text-md text-indigo-300">${e.name}</h4>\n                        <p class="text-sm text-gray-400 my-2">${e.description||"No description."}</p>\n                        ${e.url?`<a href="${e.url}" target="_blank" rel="noopener noreferrer" class="inline-block text-sm text-blue-400 hover:underline">Open Link <i class="fas fa-external-link-alt ml-1"></i></a>`:""}\n                    </div>\n                    ${t}\n                </div>\n            `}).join("")}\n                </div>\n            </div>\n        `).join("");return`\n        <div class="mt-6">\n            <button id="back-to-subjects-btn" class="text-sm text-indigo-400 hover:underline mb-4"><i class="fas fa-arrow-left mr-2"></i>Back to Subjects</button>\n            <h2 class="text-2xl font-bold mb-4">Notes for ${e}</h2>\n            ${s}\n        </div>\n    `}(e)}n("#back-to-subjects-btn")&&Y(),n("#save-teacher-profile-btn")&&qe(n("#save-teacher-profile-btn").dataset.userId),n("#save-parent-profile-btn")&&Me(n("#save-parent-profile-btn").dataset.userId),n("#open-add-specialty-modal-btn")&&ze(n("#open-add-specialty-modal-btn").dataset.userId);const P=n(".delete-specialty-btn");if(P){const e=P.dataset.id,t=P.dataset.teacherId;f("Delete Specialty","Are you sure you want to remove this specialty?",async()=>{$("Deleting specialty...");try{await((e,t)=>Q(`/teachers/${e}/specialties/${t}`,{method:"DELETE"}))(t,e),k("success","Specialty removed."),Y()}catch(n){k("error",n.message)}})}n("#btn-create-student")&&U(null,"create").then(e=>{document.getElementById("page-content").innerHTML=e});const A=n(".btn-view-student");A&&U(A.dataset.id,"edit").then(e=>{document.getElementById("page-content").innerHTML=e}),n("#save-student-details-btn")&&async function(e){const t=document.getElementById("st-first-name").value.trim(),n=document.getElementById("st-last-name").value.trim(),a=parseInt(document.getElementById("st-grade").value),s=document.getElementById("st-email").value.trim(),r=document.getElementById("st-status"),i=document.getElementById("st-cost"),o=document.getElementById("st-min-duration"),d=document.getElementById("st-max-duration"),l=r?r.value:"NONE",c=i?parseFloat(i.value):6,u=o?parseInt(o.value):60,m=d?parseInt(d.value):90;if(t&&n&&!isNaN(a)){$("Saving Details...");try{const g={first_name:t,last_name:n,grade:a};r&&(g.status=l),i&&(g.cost=c),o&&(g.min_duration_mins=u),d&&(g.max_duration_mins=m),s&&(g.email=s),await Ee(e,g),k("success","Details saved successfully.")}catch(g){k("error",g.message)}finally{S()}}else k("error","Name and Grade are required.")}(n("#save-student-details-btn").dataset.studentId),n("#save-student-availability-btn")&&async function(e){if(N){$("Saving Availability...");try{const t={student_availability_intervals:C(N.availability)};await Ee(e,t),k("success","Availability saved successfully.")}catch(t){k("error",t.message)}finally{S()}}}(n("#save-student-availability-btn").dataset.studentId),n("#create-student-btn")&&async function(){const e=document.getElementById("st-first-name").value.trim(),t=document.getElementById("st-last-name").value.trim(),n=parseInt(document.getElementById("st-grade").value),a=document.getElementById("st-status"),s=document.getElementById("st-cost"),r=document.getElementById("st-min-duration"),i=document.getElementById("st-max-duration"),o=a?a.value:"NONE",d=s?parseFloat(s.value):6,l=r?parseInt(r.value):60,c=i?parseInt(i.value):90;if(e&&t&&!isNaN(n)){$("Creating Student...");try{const a=N?C(N.availability):[],s=(N?.student_subjects||[]).map(e=>({subject:e.subject,teacher_id:e.teacher_id,educational_system:e.educational_system,grade:e.grade,lessons_per_week:e.lessons_per_week,shared_with_student_ids:e.shared_with_student_ids||[]})),r={first_name:e,last_name:t,parent_id:p.currentUser.id,grade:n,status:o,cost:d,min_duration_mins:l,max_duration_mins:c,student_subjects:s,student_availability_intervals:a};await se(p.currentUser.id,r),k("success","Student created successfully!"),"parent"===p.currentUser.role&&Y()}catch(u){k("error",u.message)}finally{S()}}else k("error","Name and Grade are required.")}(),n("#add-student-subject-btn")&&function(t){const n="teacher"===p.currentUser.role;y("Enroll in Subject",`\n        <div class="space-y-4" id="add-subject-form">\n            <div class="grid grid-cols-2 gap-4">\n                <div>\n                    <label class="text-sm text-gray-400">Subject</label>\n                    <select id="sub-subject" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">${b.noteSubjects.map(e=>`<option value="${e}">${e}</option>`).join("")}</select>\n                </div>\n                <div>\n                    <label class="text-sm text-gray-400">System</label>\n                    <select id="sub-system" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">${b.educationalSystems.map(e=>`<option value="${e}">${e}</option>`).join("")}</select>\n                </div>\n            </div>\n            <div>\n                <label class="text-sm text-gray-400">Grade</label>\n                <input type="number" id="sub-grade" min="1" max="12" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600" placeholder="Grade">\n            </div>\n            \n            ${n?"":'\n            <div id="teacher-selection-container" class="hidden">\n                <label class="text-sm text-gray-400">Select Teacher</label>\n                <select id="sub-teacher" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></select>\n                <p id="teacher-loading-msg" class="text-xs text-yellow-400 hidden mt-1">Finding teachers...</p>\n            </div>'}\n\n            <div>\n                <label class="text-sm text-gray-400">Lessons Per Week</label>\n                <input type="number" id="sub-lessons" min="1" value="1" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">\n            </div>\n        </div>\n    `,`\n        <div class="flex justify-end space-x-3">\n            ${n?"":'<button id="find-teachers-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-md">Find Teachers</button>'}\n            <button id="save-subject-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-md ${n?"":"hidden"}">Add Subject</button>\n        </div>\n    `,a=>{const s=a.querySelector("#find-teachers-btn"),r=a.querySelector("#save-subject-btn"),i=a.querySelector("#teacher-selection-container"),o=a.querySelector("#sub-teacher");let d=[];s&&s.addEventListener("click",async()=>{const t=a.querySelector("#sub-subject").value,n=a.querySelector("#sub-system").value,l=parseInt(a.querySelector("#sub-grade").value);if(t&&n&&!isNaN(l)){s.disabled=!0,s.textContent="Searching...";try{d=await Ne(t,n,l),o.innerHTML="",0===d.length?(alert("No teachers found for this combination."),i.classList.add("hidden")):(d.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=`${e.first_name} ${e.last_name} (${e.email})`,o.appendChild(t)}),i.classList.remove("hidden"),r.classList.remove("hidden"),s.classList.add("hidden"))}catch(e){alert("Error fetching teachers: "+e.message)}finally{s.disabled=!1,s.textContent="Find Teachers"}}else alert("Please select Subject, System and Grade.")}),r.addEventListener("click",async()=>{const s=n?p.currentUser.id:o.value;if(s)if("new"===t){const e={subject:a.querySelector("#sub-subject").value,educational_system:a.querySelector("#sub-system").value,grade:parseInt(a.querySelector("#sub-grade").value),teacher_id:s,lessons_per_week:parseInt(a.querySelector("#sub-lessons").value),shared_with_student_ids:[],teacherObject:n?p.currentUser:d.find(e=>e.id===s)};N&&N.student_subjects&&N.student_subjects.push(e),h();const t=await U(null,"create");document.getElementById("page-content").innerHTML=t}else{$("Adding subject...");try{const e=await ae(t),n={subject:a.querySelector("#sub-subject").value,educational_system:a.querySelector("#sub-system").value,grade:parseInt(a.querySelector("#sub-grade").value),teacher_id:s,lessons_per_week:parseInt(a.querySelector("#sub-lessons").value),shared_with_student_ids:[]},r=e.student_subjects.map(e=>({subject:e.subject,educational_system:e.educational_system,grade:e.grade,teacher_id:e.teacher_id,lessons_per_week:e.lessons_per_week,shared_with_student_ids:e.shared_with_student_ids}));r.push(n),await Ee(t,{student_subjects:r}),h(),k("success","Subject added.");const i=await U(t,"edit");document.getElementById("page-content").innerHTML=i}catch(e){k("error",e.message)}finally{S()}}else alert("Please select a teacher.")})})}(n("#add-student-subject-btn").dataset.studentId);const D=n(".remove-subject-btn");if(D&&async function(t,n){const a="new"===t;f("Remove Subject","Are you sure you want to drop this subject?",async()=>{if(a){N&&N.student_subjects&&N.student_subjects.splice(n,1),h();const e=await U(null,"create");document.getElementById("page-content").innerHTML=e}else{$("Removing subject...");try{const e=(await ae(t)).student_subjects.map(e=>({subject:e.subject,educational_system:e.educational_system,grade:e.grade,teacher_id:e.teacher_id,lessons_per_week:e.lessons_per_week,shared_with_student_ids:e.shared_with_student_ids}));e.splice(n,1),await Ee(t,{student_subjects:e}),k("success","Subject removed.");const a=await U(t,"edit");document.getElementById("page-content").innerHTML=a}catch(e){k("error",e.message)}finally{S()}}})}(D.dataset.studentId,parseInt(D.dataset.subjectIndex)),n("#cancel-create-student-btn")&&Y(),n("#profile-timetable-wrapper")){const a=n("#timetable-grid-main");a&&t===a&&O("add",a.dataset.dayKey,e.offsetY);const s=n(".event-bubble");s&&a&&O("edit",a.dataset.dayKey,s.dataset.start);const r=n(".set-all-times-btn");r&&O("setAll",r.dataset.type)}if(n("#page-content .timetable-component")){const e=n(".day-nav-btn");if(e){const t=parseInt(e.dataset.direction);p.currentTimetableDay=(p.currentTimetableDay+t+7)%7,n("#profile-timetable-wrapper")?B():Y()}}}),document.getElementById("page-content").addEventListener("change",e=>{if("student-selector"===e.target.id&&(p.currentStudent=p.students.find(t=>t.id===e.target.value)||null,Y()),"notes-student-selector"===e.target.id&&(p.notesStudentFilter=e.target.value,Y()),"role"===e.target.id&&He(),"teacher-student-selector"===e.target.id){const t=e.target.value,n=document.getElementById("teacher-student-profile-container");t?U(t,"edit").then(e=>{n.innerHTML=e}):n.innerHTML='<div class="text-center text-gray-500 py-8">Select a student above to view and edit their details.</div>'}}),Ae.addListener("backButton",({canGoBack:e})=>{document.getElementById("modal-backdrop")?h():p.isSidebarOpen&&window.innerWidth<768?E():Ae.exitApp()}),async function e(){V("login"),function(){const e=document.getElementById("sidebar");window.innerWidth>=768?(e.classList.add("open"),p.isSidebarOpen=!0):(e.classList.remove("open"),p.isSidebarOpen=!1)}(),$("Connecting to server...");try{if(await fetch(b.backendUrl),console.log("Backend connection successful."),S(),await K(),i.isNativePlatform())try{"granted"===(await Ue.requestPermissions()).receive&&await Ue.register(),Ue.addListener("registration",e=>{console.log("Push Registration Token:",e.value)}),Ue.addListener("pushNotificationReceived",e=>{k("info",e.title||"New Notification")})}catch(t){console.warn("Push notification setup failed:",t)}}catch(n){console.error("Initialization Error:",n),S(),L(n.message),document.getElementById("retry-connection-btn")?.addEventListener("click",e)}}()}}});
