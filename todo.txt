# make a new branch with the latest implementation:

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EfficientTutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --surface-color: #2c2c2c;
            --primary-color: #4f46e5;
            --text-color: #e5e7eb;
            --text-muted-color: #9ca3af;
            --border-color: #404040;
            --school-color: #facc15; /* yellow-400 */
            --sports-color: #f97316; /* orange-500 */
            --others-color: #4ade80; /* green-400 */
            --tuition-color: #60a5fa; /* blue-400 */
            --sleep-color: #9333ea;  /* purple-600 */
        }
        html.light {
            --bg-color: #f3f4f6;
            --surface-color: #ffffff;
            --primary-color: #4f46e5;
            --text-color: #111827;
            --text-muted-color: #6b7280;
            --border-color: #e5e7eb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overscroll-behavior: none;
        }
        .app-container { display: flex; height: 100vh; width: 100vw; overflow: hidden; }
        .sidebar { width: 250px; background-color: var(--surface-color); border-right: 1px solid var(--border-color); transition: transform 0.3s ease-in-out; transform: translateX(-100%); position: fixed; top: 0; left: 0; height: 100%; z-index: 50; }
        .sidebar.open { transform: translateX(0); }
        .main-content { flex-grow: 1; transition: margin-left 0.3s ease-in-out; height: 100vh; overflow-y: auto; }
        .timetable-grid { position: relative; height: calc(24 * 60px); }
        .time-label { height: 60px; }
        .event-bubble { position: absolute; left: 0; right: 0; margin: 0 4px; padding: 4px 8px; border-radius: 8px; font-size: 0.8rem; overflow: hidden; border: 1px solid rgba(0,0,0,0.2); color: #111827; }
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .modal-content { background-color: var(--surface-color); padding: 1.5rem; border-radius: 1rem; width: 100%; max-width: 500px; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header, .modal-footer { flex-shrink: 0; }
        .modal-body { flex-grow: 1; overflow-y: auto; padding-right: 0.5rem; margin-right: -0.5rem; padding-bottom: 1rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.8); z-index: 200; display: flex; align-items: center; justify-content: center; text-align: center; color: white; flex-direction: column; gap: 1rem; }
        .share-dropdown { position: absolute; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem; z-index: 120; max-height: 150px; overflow-y: auto; }
        @media (min-width: 768px) { .sidebar { position: static; transform: translateX(0); } .main-content { margin-left: 0; } #menu-button { display: none; } }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app-container" class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar flex flex-col p-4">
            <h1 class="text-2xl font-bold text-indigo-400 mb-8">EfficientTutor</h1>
            <nav class="flex flex-col space-y-2">
                <a href="#" id="nav-timetable" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-calendar-alt w-6 mr-3"></i> Timetable</a>
                <a href="#" id="nav-logs" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-history w-6 mr-3"></i> Logs</a>
                <a href="#" id="nav-student-info" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-user-graduate w-6 mr-3"></i> Student Info</a>
                <a href="#" id="nav-settings" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-cog w-6 mr-3"></i> Settings</a>
            </nav>
            <div class="mt-auto">
                <div id="user-info" class="text-sm text-gray-400 mb-2 hidden">
                    <p>Logged in as:</p>
                    <p id="user-email" class="font-semibold break-all"></p>
                </div>
                <button id="logout-button" class="w-full text-left flex items-center p-2 rounded-lg hover:bg-red-800/50 text-red-400 hidden">
                    <i class="fas fa-sign-out-alt w-6 mr-3"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="main-content">
            <header class="sticky top-0 bg-gray-900/80 backdrop-blur-sm p-4 flex items-center border-b border-gray-700 z-40">
                <button id="menu-button" class="md:hidden mr-4 p-2 rounded-md hover:bg-gray-700">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h2 id="page-title" class="text-xl font-semibold">Login</h2>
            </header>
            <div id="page-content" class="p-4 md:p-6">
                <!-- All pages will be rendered here -->
            </div>
        </main>
    </div>

    <!-- Modals and Overlays will be appended here -->
    <div id="modal-container"></div>
    <div id="status-overlay-container"></div>

    <script type="module">
        // --- CONFIGURATION ---
        const config = {
            backendUrl: window.location.hostname === '127.0.0.1' 
                ? 'http://127.0.0.1:5000' 
                : 'https://personal-time-manager.onrender.com', // Replace with your production URL if needed
            subjects: ['Math', 'Physics', 'Chemistry', 'Biology', 'IT'],
            colors: {
                school: 'var(--school-color)',
                sports: 'var(--sports-color)',
                others: 'var(--others-color)',
                tuition: 'var(--tuition-color)',
                sleep: 'var(--sleep-color)',
            },
            defaultSchoolTimes: { start: '06:00', end: '15:00' },
            defaultSleepTimes: { start: '22:00', end: '05:00' },
            daysOfWeek: ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'],
            timeSlotsStartHour: 5,
            pixelsPerMinute: 1,
        };
        
        // --- GLOBAL STATE ---
        let appState = {
            currentUser: null,
            students: [],
            currentStudent: null,
            currentPage: 'login',
            currentTimetableDay: new Date().getDay() + 1 > 6 ? 0 : new Date().getDay() + 1,
            isSidebarOpen: false,
        };

        // --- AUTHENTICATION ---
        async function checkAuthState() {
            const user = JSON.parse(localStorage.getItem('efficientTutorUser'));
            if (user && user.id) {
                appState.currentUser = user;
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('logout-button').classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
                await loadStudents();
                if (appState.currentUser.isFirstSignIn && appState.students.length === 0) {
                    navigateTo('student-info');
                } else {
                    navigateTo('timetable');
                }
            } else {
                navigateTo('login');
            }
        }

        async function handleLogin(email, password) {
            showLoadingOverlay('Logging in...');
            try {
                const response = await fetch(`${config.backendUrl}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Login failed.');
                
                localStorage.setItem('efficientTutorUser', JSON.stringify(data.user));
                await checkAuthState();
            } catch (error) {
                showStatusMessage('error', error.message);
            } finally {
                hideStatusOverlay();
            }
        }

        async function handleSignup(email, password) {
            showLoadingOverlay('Signing up...');
            try {
                const response = await fetch(`${config.backendUrl}/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Signup failed.');

                localStorage.setItem('efficientTutorUser', JSON.stringify(data.user));
                await checkAuthState();
            } catch (error) {
                showStatusMessage('error', error.message);
            } finally {
                hideStatusOverlay();
            }
        }

        function handleLogout() {
            localStorage.removeItem('efficientTutorUser');
            appState.currentUser = null;
            appState.students = [];
            appState.currentStudent = null;
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('logout-button').classList.add('hidden');
            navigateTo('login');
        }

        // --- NAVIGATION & PAGE RENDERING ---
        const pageContent = document.getElementById('page-content');
        const pageTitle = document.getElementById('page-title');

        function navigateTo(pageId) {
            appState.currentPage = pageId;
            if (appState.isSidebarOpen) toggleSidebar();
            renderPage();
        }

        async function renderPage() {
            pageContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
            try {
                switch(appState.currentPage) {
                    case 'login': pageTitle.textContent = 'Login / Sign Up'; pageContent.innerHTML = renderLoginPage(); break;
                    case 'timetable': pageTitle.textContent = 'Timetable'; pageContent.innerHTML = await renderTimetablePage(); break;
                    case 'logs': pageTitle.textContent = 'Logs'; pageContent.innerHTML = await renderLogsPage(); break;
                    case 'student-info': pageTitle.textContent = 'Student Info'; pageContent.innerHTML = renderStudentInfoPage(); break;
                    case 'settings': pageTitle.textContent = 'Settings'; pageContent.innerHTML = renderSettingsPage(); break;
                }
            } catch (error) {
                console.error("Failed to render page:", error);
                displayGlobalError(`Error loading page: ${error.message}`);
            }
        }
        
        // --- EVENT HANDLERS ---
        document.body.addEventListener('click', (e) => {
            const target = e.target;
            const closest = (selector) => target.closest(selector);

            if (!closest('.share-container')) {
                document.querySelectorAll('.share-dropdown').forEach(el => el.classList.add('hidden'));
            }

            if (closest('#login-btn')) { e.preventDefault(); handleLogin(document.getElementById('email').value, document.getElementById('password').value); }
            if (closest('#signup-btn')) { e.preventDefault(); handleSignup(document.getElementById('email').value, document.getElementById('password').value); }
            if (closest('#logout-button')) handleLogout();

            const navLink = closest('.nav-link');
            if (navLink) { e.preventDefault(); navigateTo(navLink.id.replace('nav-', '')); }
            if (closest('#menu-button')) toggleSidebar();
            if (closest('#add-new-student-btn')) showStudentRegistrationWizard();

            const editStudentBtn = closest('.edit-student-btn');
            if (editStudentBtn) { const student = appState.students.find(s => s.id === editStudentBtn.dataset.id); if (student) showStudentRegistrationWizard(student); }
            const deleteStudentBtn = closest('.delete-student-btn');
            if (deleteStudentBtn) { const student = appState.students.find(s => s.id === deleteStudentBtn.dataset.id); if (student) confirmDeleteStudent(student); }
            if (closest('#theme-toggle-btn')) { document.documentElement.classList.toggle('dark'); document.documentElement.classList.toggle('light'); renderPage(); }
            if (closest('#modal-close-btn') || (closest('#modal-backdrop') && !closest('.modal-content'))) { closeModal(); }
            
            const mainTimetable = closest('#page-content .timetable-component');
            if (mainTimetable) {
                const dayNavBtn = closest('.day-nav-btn');
                if (dayNavBtn) {
                    const dir = parseInt(dayNavBtn.dataset.direction);
                    appState.currentTimetableDay = (appState.currentTimetableDay + dir + 7) % 7;
                    renderPage();
                }
            }
        });
        
        pageContent.addEventListener('change', (e) => {
            if (e.target.id === 'student-selector') {
                appState.currentStudent = appState.students.find(s => s.id === e.target.value) || null;
                renderPage();
            }
        });

        // --- TEMPLATES ---
        function renderLoginPage() { return `<div class="max-w-md mx-auto mt-10 bg-gray-800 p-8 rounded-xl shadow-lg"><h3 class="text-2xl font-bold text-center mb-6">Welcome to EfficientTutor</h3><form id="login-form" class="space-y-4"><input type="email" id="email" placeholder="Email" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none"><input type="password" id="password" placeholder="Password" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none"><div class="flex space-x-4"><button type="submit" id="login-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">Login</button><button type="button" id="signup-btn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-md transition duration-300">Sign Up</button></div></form></div>`; }
        function renderStudentInfoPage() {
            let studentListHTML = appState.students.map(student => `<div class="bg-gray-800 p-4 rounded-lg flex items-center justify-between"><div><p class="font-semibold text-lg">${student.basicInfo.firstName} ${student.basicInfo.lastName}</p><p class="text-sm text-gray-400">Grade: ${student.basicInfo.grade}</p></div><div class="space-x-2"><button class="edit-student-btn p-2 bg-gray-600 hover:bg-gray-500 rounded-md" data-id="${student.id}"><i class="fas fa-edit"></i></button><button class="delete-student-btn p-2 bg-red-600 hover:bg-red-500 rounded-md" data-id="${student.id}"><i class="fas fa-trash"></i></button></div></div>`).join('');
            if (appState.students.length === 0) studentListHTML = `<p class="text-center text-gray-400 py-8">No students registered yet. Add one to get started!</p>`;
            return `<div class="space-y-4">${studentListHTML}</div><button id="add-new-student-btn" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 flex items-center justify-center"><i class="fas fa-plus mr-2"></i> Add New Student</button>`;
        }
        function confirmDeleteStudent(student) {
            const footer = `<div class="flex justify-end space-x-4"><button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button><button id="modal-confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-md">Delete</button></div>`;
            showModal('Confirm Deletion', `<p>Are you sure you want to delete ${student.basicInfo.firstName}?</p>`, footer, (modal) => {
                modal.addEventListener('click', (e) => {
                    if (e.target.closest('#modal-confirm-delete-btn')) { deleteStudent(student.id); closeModal(); }
                    if (e.target.closest('#modal-cancel-btn')) closeModal();
                });
            });
        }

        // --- STUDENT REGISTRATION WIZARD ---
        function showStudentRegistrationWizard(studentToEdit = null) {
            let step = 1;
            let registrationData = studentToEdit ? JSON.parse(JSON.stringify(studentToEdit)) : { id: crypto.randomUUID(), basicInfo: { firstName: '', lastName: '', grade: '' }, subjects: [], availability: {} };
            if (!studentToEdit) {
                const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday'];
                config.daysOfWeek.forEach(day => {
                    const dayKey = day.toLowerCase();
                    registrationData.availability[dayKey] = [];
                    registrationData.availability[dayKey].push({ type: 'sleep', ...config.defaultSleepTimes });
                    if (weekdays.includes(day)) {
                        registrationData.availability[dayKey].push({ type: 'school', ...config.defaultSchoolTimes });
                    }
                });
            }
            
            const renderCurrentStep = () => {
                let bodyContent = '', footerContent = '';
                switch(step) {
                    case 1: bodyContent = wizardStep1(registrationData); footerContent = `<div class="flex justify-end"><button id="wizard-next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Next</button></div>`; break;
                    case 2: bodyContent = wizardStep2(registrationData); footerContent = `<div class="flex justify-end"><button id="wizard-next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Next</button></div>`; break;
                    case 3: bodyContent = wizardStep3(registrationData); footerContent = `<div class="flex justify-end"><button id="wizard-next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Next</button></div>`; break;
                    case 4: bodyContent = wizardStep4(); footerContent = `<div class="flex justify-center"><button id="wizard-finish-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-md">Finish</button></div>`; break;
                }
                showModal(`Student Registration - Step ${step} of 4`, bodyContent, footerContent, (modal) => attachWizardListeners(modal, registrationData));
            };
            
            const attachWizardListeners = (modal, data) => {
                modal.addEventListener('click', async (e) => {
                    const target = e.target; const closest = (selector) => target.closest(selector);
                    if (closest('#wizard-next-btn')) { if (validateStep(step, data, modal)) { step++; renderCurrentStep(); } }
                    else if (closest('#wizard-finish-btn')) { await saveStudent(data); }
                    if (step === 2) {
                        if (closest('#add-subject-btn')) {
                            const name = modal.querySelector('#subject-select').value;
                            const lessons = parseInt(modal.querySelector('#lessons-per-week').value);
                            if (lessons > 0 && !data.subjects.find(s => s.name === name)) { data.subjects.push({ name: name, lessonsPerWeek: lessons, sharedWith: [] }); renderCurrentStep(); }
                        }
                        const removeBtn = closest('.remove-subject-btn');
                        if (removeBtn) { data.subjects.splice(parseInt(removeBtn.dataset.index), 1); renderCurrentStep(); }
                        const shareBtn = closest('.share-btn');
                        if (shareBtn) {
                            const dropdown = shareBtn.nextElementSibling;
                            const isHidden = dropdown.classList.contains('hidden');
                            document.querySelectorAll('.share-dropdown').forEach(el => el.classList.add('hidden'));
                            if(isHidden) dropdown.classList.remove('hidden');
                        }
                    }
                    if (step === 3) {
                        const dayNavBtn = closest('.day-nav-btn');
                        if (dayNavBtn) { appState.currentTimetableDay = (appState.currentTimetableDay + parseInt(dayNavBtn.dataset.direction) + 7) % 7; renderCurrentStep(); }
                        const updateWizardTimetable = () => { const container = modal.querySelector('#wizard-timetable-container'); if (container) container.innerHTML = renderTimetableComponent(true, data); };
                        const grid = closest('#timetable-grid-main');
                        if(grid && e.target === grid) { showAddEventModal(data, grid.dataset.dayKey, e.offsetY, updateWizardTimetable); }
                        const bubble = closest('.event-bubble');
                        if (bubble && bubble.dataset.type !== 'tuition') { showEditEventModal(data, grid.dataset.dayKey, bubble.dataset.start, updateWizardTimetable); }
                        const setAllBtn = closest('.set-all-times-btn');
                        if(setAllBtn) { const type = setAllBtn.dataset.type; showSetAllTimesModal(data, type, updateWizardTimetable); }
                    }
                });
                modal.addEventListener('change', (e) => {
                    const target = e.target; const closest = (selector) => target.closest(selector);
                    const shareCheckbox = closest('.share-checkbox');
                    if(shareCheckbox) {
                        const subjectIndex = parseInt(shareCheckbox.dataset.subjectIndex); const studentId = shareCheckbox.dataset.studentId; const sharedWith = data.subjects[subjectIndex].sharedWith;
                        if(shareCheckbox.checked) { if(!sharedWith.includes(studentId)) sharedWith.push(studentId); } 
                        else { const indexToRemove = sharedWith.indexOf(studentId); if (indexToRemove > -1) sharedWith.splice(indexToRemove, 1); }
                        renderCurrentStep();
                    }
                });
            };
            renderCurrentStep();
        }
        function wizardStep1(data) { return `<div class="space-y-4"><input type="text" id="firstName" placeholder="First Name" value="${data.basicInfo.firstName}" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600"><input type="text" id="lastName" placeholder="Last Name" value="${data.basicInfo.lastName}" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600"><input type="text" id="grade" placeholder="Grade (e.g., 10)" value="${data.basicInfo.grade}" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600"></div>`; }
        function wizardStep2(data) {
            const subjectOptions = config.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            const otherStudents = appState.students.filter(s => s.id !== data.id);
            const registeredSubjectsHTML = data.subjects.map((subject, index) => {
                const sharedWithNames = subject.sharedWith.map(studentId => { const student = appState.students.find(s => s.id === studentId); return student ? student.basicInfo.firstName : ''; }).filter(Boolean).join(', ');
                const dropdownOptions = otherStudents.length > 0 ? otherStudents.map(student => `<label class="flex items-center space-x-2 p-1 hover:bg-gray-600 rounded-md"><input type="checkbox" class="share-checkbox" data-subject-index="${index}" data-student-id="${student.id}" ${subject.sharedWith.includes(student.id) ? 'checked' : ''}><span>${student.basicInfo.firstName} ${student.basicInfo.lastName}</span></label>`).join('') : '<div class="px-2 py-1 text-sm text-gray-400">No other students to share with.</div>';
                return `<div class="bg-gray-700 p-2 rounded-md"><div class="flex justify-between items-center"><div><p>${subject.name} - ${subject.lessonsPerWeek} lessons/week</p>${sharedWithNames ? `<p class="text-xs text-indigo-300">Shared with: ${sharedWithNames}</p>` : ''}</div><div class="flex items-center space-x-2"><div class="relative share-container"><button class="share-btn p-2 text-sm bg-indigo-600 hover:bg-indigo-700 rounded-md"><i class="fas fa-users mr-1"></i> Allowed Others</button><div class="share-dropdown hidden absolute right-0 mt-1 w-48">${dropdownOptions}</div></div><button class="remove-subject-btn text-red-400 hover:text-red-300" data-index="${index}"><i class="fas fa-times-circle"></i></button></div></div></div>`;
            }).join('');
            return `<div id="registered-subjects-list" class="space-y-2 mb-4">${registeredSubjectsHTML || '<p class="text-sm text-gray-400">No subjects added yet.</p>'}</div><div class="flex space-x-2"><select id="subject-select" class="flex-grow p-2 bg-gray-700 rounded-md border border-gray-600">${subjectOptions}</select><input type="number" id="lessons-per-week" placeholder="Lessons/wk" min="1" value="1" class="w-28 p-2 bg-gray-700 rounded-md border border-gray-600"><button id="add-subject-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-md"><i class="fas fa-plus"></i> Add</button></div>`;
        }
        function wizardStep3(data) { return `<div id="wizard-timetable-container">${renderTimetableComponent(true, data)}</div>`; }
        function wizardStep4() { return `<div class="text-center py-8"><i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h3 class="text-2xl font-semibold">All Set!</h3><p class="text-gray-400 mt-2">All student information has been entered. Click Finish to save.</p></div>`; }
        function validateStep(step, data, modal) { if (step === 1) { const firstName = modal.querySelector('#firstName').value.trim(); const lastName = modal.querySelector('#lastName').value.trim(); const grade = modal.querySelector('#grade').value.trim(); if (!firstName || !lastName || !grade) { showInfoModal('Validation Error', '<p>Please fill in all fields.</p>'); return false; } data.basicInfo = { firstName, lastName, grade }; } return true; }

        // --- DATA & BACKEND ---
        async function loadStudents() {
            if (!appState.currentUser) return;
            try {
                const response = await fetch(`${config.backendUrl}/students?userId=${appState.currentUser.id}`);
                if (!response.ok) throw new Error('Could not fetch students.');
                appState.students = await response.json();
                appState.currentStudent = appState.students[0] || null;
            } catch (error) { console.error("Error loading students:", error); showInfoModal('Error', `<p>${error.message}</p>`); }
        }
        async function saveStudent(studentData) {
            if (!appState.currentUser) return;
            showLoadingOverlay('Saving student data...');
            try {
                const response = await fetch(`${config.backendUrl}/students`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: appState.currentUser.id, student: studentData })
                });
                if (!response.ok) throw new Error('Could not save student data.');
                if (appState.currentUser.isFirstSignIn) {
                    appState.currentUser.isFirstSignIn = false;
                    localStorage.setItem('efficientTutorUser', JSON.stringify(appState.currentUser));
                }
                await loadStudents();
                closeModal();
                showStatusMessage('success', 'Student saved successfully!');
                navigateTo('student-info');
            } catch (error) { console.error("Error saving student:", error); showStatusMessage('error', error.message); }
        }
        async function deleteStudent(studentId) {
            if (!appState.currentUser) return;
            showLoadingOverlay('Deleting student...');
            try {
                const response = await fetch(`${config.backendUrl}/students`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: appState.currentUser.id, studentId: studentId })
                });
                if (!response.ok) throw new Error('Could not delete student.');
                await loadStudents();
                showStatusMessage('success', 'Student deleted.');
                renderPage();
            } catch (error) { console.error("Error deleting student:", error); showStatusMessage('error', error.message); }
        }
        
        // --- TIMETABLE ---
        async function renderTimetablePage() {
            if (!appState.currentStudent) return `<div class="text-center p-8 text-gray-400">No student selected. Please add or select a student from the 'Student Info' page.</div>`;
            try {
                const response = await fetch(`${config.backendUrl}/timetable?student_id=${appState.currentStudent.id}`);
                if (!response.ok) throw new Error('Failed to fetch timetable.');
                const backendTimetable = await response.json();
                return renderTimetableComponent(false, appState.currentStudent, backendTimetable.tuitions);
            } catch (error) { console.error("Error fetching timetable:", error); return renderTimetableComponent(false, appState.currentStudent, []); }
        }
        function renderTimetableComponent(isWizard, dataSource, tuitions = []) {
            const dayKey = config.daysOfWeek[appState.currentTimetableDay].toLowerCase();
            const availability = dataSource.availability ? (dataSource.availability[dayKey] || []) : [];
            const tuitionsForDay = isWizard ? [] : tuitions.filter(t => t.day === dayKey);
            let timeLabelsHTML = '';
            for (let hour = config.timeSlotsStartHour; hour < 24 + config.timeSlotsStartHour; hour++) { const displayHour = hour % 24; let formattedHour = displayHour % 12; if (formattedHour === 0) formattedHour = 12; timeLabelsHTML += `<div class="time-label text-right pr-2 text-xs text-gray-500 border-t border-gray-700 flex items-center justify-end">${formattedHour} ${displayHour >= 12 ? 'PM' : 'AM'}</div>`; }
            
            const timeToPixels = (timeStr) => {
                if(!timeStr) return 0; const [h, m] = timeStr.split(':').map(Number);
                let totalMinutes = h * 60 + m;
                if (h < config.timeSlotsStartHour) totalMinutes += 24 * 60;
                return (totalMinutes - (config.timeSlotsStartHour * 60)) * config.pixelsPerMinute;
            }
            const eventBubblesHTML = [...availability, ...tuitionsForDay].map(event => {
                if(!event.start || !event.end) return ''; 
                const top = timeToPixels(event.start);
                const bottom = timeToPixels(event.end);
                if (bottom <= top) { // Overnight event
                    const endOfGridPixels = 24 * 60 * config.pixelsPerMinute;
                    const part1Height = endOfGridPixels - top;
                    const part2Height = bottom;
                    return createBubble(event, top, part1Height) + createBubble(event, 0, part2Height);
                }
                return createBubble(event, top, bottom - top);
            }).join('');

            function createBubble(event, top, height) {
                if (height <= 0) return '';
                const isTuition = !!event.subject, type = isTuition ? 'tuition' : event.type, color = config.colors[type], text = isTuition ? event.subject : event.type;
                return `<div class="event-bubble ${type !== 'tuition' ? 'cursor-pointer' : ''} hover:opacity-80" style="background-color: ${color}; top: ${top}px; height: ${height}px;" data-type="${type}" data-start="${event.start}" data-end="${event.end}"><p class="font-bold capitalize">${text}</p><p>${event.start} - ${event.end}</p></div>`;
            }
            const wizardButtons = isWizard ? `<div class="flex space-x-2 mb-4"><button class="set-all-times-btn flex-1 text-sm bg-gray-600 hover:bg-gray-500 rounded-md py-2" data-type="school"><i class="fas fa-school mr-2"></i> Set All School Times</button><button class="set-all-times-btn flex-1 text-sm bg-gray-600 hover:bg-gray-500 rounded-md py-2" data-type="sleep"><i class="fas fa-bed mr-2"></i> Set All Sleep Times</button></div>` : '';
            return `<div class="timetable-component">${wizardButtons}${!isWizard ? renderStudentSelector() : ''}<div class="flex justify-between items-center p-4 bg-gray-800 rounded-lg mb-4"><button class="day-nav-btn p-2 rounded-md hover:bg-gray-700" data-direction="-1"><i class="fas fa-chevron-left"></i></button><h3 class="text-xl font-semibold">${config.daysOfWeek[appState.currentTimetableDay]}</h3><button class="day-nav-btn p-2 rounded-md hover:bg-gray-700" data-direction="1"><i class="fas fa-chevron-right"></i></button></div><div class="flex"><div class="w-16 flex-shrink-0">${timeLabelsHTML}</div><div class="timetable-grid flex-grow bg-gray-800/50 rounded-lg" id="timetable-grid-main" data-day-key="${dayKey}">${eventBubblesHTML}</div></div></div>`;
        }
        function renderStudentSelector() {
            if (appState.students.length <= 1) return '';
            const options = appState.students.map(s => `<option value="${s.id}" ${appState.currentStudent && appState.currentStudent.id === s.id ? 'selected' : ''}>${s.basicInfo.firstName} ${s.basicInfo.lastName}</option>`).join('');
            return `<div class="mb-4"><label for="student-selector" class="text-sm text-gray-400">Viewing Timetable for:</label><select id="student-selector" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">${options}</select></div>`;
        }
        function showAddEventModal(dataSource, dayKey, pixelY, onUpdate) {
            const totalMinutes = (pixelY / config.pixelsPerMinute) + (config.timeSlotsStartHour * 60); const hour = Math.floor(totalMinutes / 60) % 24; const minute = Math.floor(totalMinutes % 60 / 15) * 15; const startTime = `${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`;
            const body = `<div class="space-y-4"><div><label class="text-sm text-gray-400">Activity Type</label><select id="add-event-type" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"><option value="sports">Sports Activity</option><option value="others">Others</option></select></div><div class="grid grid-cols-2 gap-4"><div><label class="text-sm text-gray-400">Start Time</label><input type="time" id="add-event-start" value="${startTime}" step="900" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div><div><label class="text-sm text-gray-400">End Time</label><input type="time" id="add-event-end" value="${startTime}" step="900" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div></div></div>`;
            const footer = `<div class="flex justify-end space-x-4"><button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button><button id="modal-confirm-add-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Add</button></div>`;
            showDialog('Add Activity', body, footer, (dialog) => {
                dialog.addEventListener('click', e => {
                    if (e.target.closest('#modal-cancel-btn')) closeDialog(dialog);
                    if (e.target.closest('#modal-confirm-add-btn')) {
                        const type = dialog.querySelector('#add-event-type').value; const start = dialog.querySelector('#add-event-start').value; const end = dialog.querySelector('#add-event-end').value;
                        if (start && end) { dataSource.availability[dayKey].push({type, start, end}); onUpdate(); closeDialog(dialog); } else { alert('Please set start and end times.'); }
                    }
                });
            });
        }
        function showEditEventModal(dataSource, dayKey, startTime, onUpdate) {
            const eventList = dataSource.availability[dayKey]; const eventIndex = eventList.findIndex(e => e.start === startTime); if (eventIndex === -1) return; const event = eventList[eventIndex];
            const body = `<div class="grid grid-cols-2 gap-4"><div><label class="text-sm text-gray-400">Start Time</label><input type="time" id="edit-event-start" value="${event.start}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div><div><label class="text-sm text-gray-400">End Time</label><input type="time" id="edit-event-end" value="${event.end}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div></div><button id="delete-event-btn" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Delete Event</button>`;
            const footer = `<div class="flex justify-end space-x-4"><button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button><button id="modal-confirm-edit-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Save Changes</button></div>`;
            showDialog(`Edit ${event.type} Activity`, body, footer, (dialog) => {
                dialog.addEventListener('click', e => {
                    const target = e.target.closest('button'); if (!target) return;
                    if (target.id === 'modal-cancel-btn') closeDialog(dialog);
                    else if (target.id === 'modal-confirm-edit-btn') {
                        const newStart = dialog.querySelector('#edit-event-start').value; const newEnd = dialog.querySelector('#edit-event-end').value;
                        eventList[eventIndex] = { ...event, start: newStart, end: newEnd }; onUpdate(); closeDialog(dialog);
                    } else if (target.id === 'delete-event-btn') { eventList.splice(eventIndex, 1); onUpdate(); closeDialog(dialog); }
                });
            });
        }
        function showSetAllTimesModal(dataSource, type, onUpdate) {
            const defaultTimes = type === 'school' ? config.defaultSchoolTimes : config.defaultSleepTimes;
            const body = `<div class="grid grid-cols-2 gap-4"><div><label class="text-sm text-gray-400">Start Time</label><input type="time" id="set-all-start" value="${defaultTimes.start}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div><div><label class="text-sm text-gray-400">End Time</label><input type="time" id="set-all-end" value="${defaultTimes.end}" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div></div>`;
            const footer = `<div class="flex justify-end space-x-4"><button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button><button id="modal-confirm-set-all-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Apply</button></div>`;
            showDialog(`Set All ${type.charAt(0).toUpperCase() + type.slice(1)} Times`, body, footer, (dialog) => {
                dialog.addEventListener('click', e => {
                    if (e.target.closest('#modal-cancel-btn')) closeDialog(dialog);
                    if (e.target.closest('#modal-confirm-set-all-btn')) {
                        const newStart = dialog.querySelector('#set-all-start').value;
                        const newEnd = dialog.querySelector('#set-all-end').value;
                        const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday'];
                        const daysToUpdate = type === 'school' ? weekdays : config.daysOfWeek;

                        daysToUpdate.forEach(day => {
                            const dayKey = day.toLowerCase();
                            if (!dataSource.availability[dayKey]) dataSource.availability[dayKey] = [];
                            const eventIndex = dataSource.availability[dayKey].findIndex(event => event.type === type);
                            if (eventIndex > -1) {
                                dataSource.availability[dayKey][eventIndex].start = newStart;
                                dataSource.availability[dayKey][eventIndex].end = newEnd;
                            } else {
                                dataSource.availability[dayKey].push({ type, start: newStart, end: newEnd });
                            }
                        });
                        onUpdate();
                        closeDialog(dialog);
                    }
                });
            });
        }
        
        // --- LOGS & SETTINGS TEMPLATES ---
        async function renderLogsPage() {
            if (!appState.currentStudent) return `<div class="text-center p-8 text-gray-400">Select a student to view logs.</div>`;
            try {
                const response = await fetch(`${config.backendUrl}/logs?student_id=${appState.currentStudent.id}`);
                if (!response.ok) throw new Error('Failed to fetch logs.');
                const logData = await response.json(); const { summary, detailed_logs } = logData;
                const logsHTML = detailed_logs.map(log => {
                    const attendees = log.attendees || [];
                    return `<div class="bg-gray-800 p-4 rounded-lg grid grid-cols-3 md:grid-cols-4 gap-4 items-center">
                        <div>
                            <p class="font-semibold">${log.subject}</p>
                            <p class="text-sm text-indigo-300">${attendees.join(', ')}</p>
                        </div>
                        <div class="text-sm text-gray-400 text-center">
                            <p>${log.date}</p>
                            <p>${log.time_start} - ${log.time_end}</p>
                        </div>
                        <div class="text-center">${log.duration}</div>
                        <div class="text-center"><span class="px-3 py-1 rounded-full text-sm font-semibold ${log.status === 'Paid' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">${log.status}</span></div>
                    </div>`
                }).join('');
                return `<div class="space-y-6"><div><h3 class="text-xl font-semibold mb-4">Summary</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-red-500">${summary.unpaid_count}</p><p class="text-gray-400">Lessons Unpaid</p></div><div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-green-500">${summary.paid_count}</p><p class="text-gray-400">Lessons Paid</p></div><div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-yellow-400">$${summary.total_due.toFixed(2)}</p><p class="text-gray-400">Total Amount Due</p></div></div></div><div><h3 class="text-xl font-semibold mb-4">Detailed Logs</h3><div class="space-y-2">${logsHTML}</div></div></div>`;
            } catch (error) { console.error("Error fetching logs:", error); return `<div class="text-center text-red-400 p-8">Error loading logs: ${error.message}</div>`; }
        }
        function renderSettingsPage() { const isDark = document.documentElement.classList.contains('dark'); return `<div class="max-w-2xl mx-auto space-y-6"><div class="bg-gray-800 p-6 rounded-lg"><h3 class="text-lg font-semibold mb-4">Appearance</h3><div class="flex items-center justify-between"><span>Theme</span><button id="theme-toggle-btn" class="px-4 py-2 rounded-md font-semibold ${isDark ? 'bg-gray-700' : 'bg-gray-300 text-gray-800'}">${isDark ? '<i class="fas fa-moon mr-2"></i>Dark' : '<i class="fas fa-sun mr-2"></i>Light'}</button></div></div><div class="bg-gray-800 p-6 rounded-lg"><h3 class="text-lg font-semibold mb-4">About</h3><p class="text-gray-400">EfficientTutor v1.0.0</p></div></div>`; }

        // --- MODAL & STATUS UTILITIES ---
        function showModal(title, bodyHTML, footerHTML, onAfterRender) { closeModal(); const modalContainer = document.getElementById('modal-container'); const modal = document.createElement('div'); modal.id = 'modal-backdrop'; modal.className = 'modal-backdrop'; modal.innerHTML = `<div class="modal-content"><div class="modal-header flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">${title}</h3><button id="modal-close-btn" class="p-2 rounded-full hover:bg-gray-700 -mr-2 -mt-2"><i class="fas fa-times"></i></button></div><div class="modal-body">${bodyHTML}</div><div class="modal-footer mt-4">${footerHTML}</div></div>`; modalContainer.appendChild(modal); if (onAfterRender) onAfterRender(modal); }
        function showDialog(title, bodyHTML, footerHTML, onAfterRender) { const modalContainer = document.getElementById('modal-container'); const dialog = document.createElement('div'); dialog.className = 'modal-backdrop'; dialog.style.zIndex = '110'; dialog.innerHTML = `<div class="modal-content"><div class="modal-header flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">${title}</h3><button class="dialog-close-btn p-2 rounded-full hover:bg-gray-700 -mr-2 -mt-2"><i class="fas fa-times"></i></button></div><div class="modal-body">${bodyHTML}</div><div class="modal-footer mt-4">${footerHTML}</div></div>`; dialog.querySelector('.dialog-close-btn').addEventListener('click', () => closeDialog(dialog)); modalContainer.appendChild(dialog); if (onAfterRender) onAfterRender(dialog); }
        function showInfoModal(title, bodyHTML) { showModal(title, bodyHTML, `<div class="flex justify-end"><button id="modal-close-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">OK</button></div>`); }
        function closeModal() { document.getElementById('modal-backdrop')?.remove(); }
        function closeDialog(dialog) { if (dialog) dialog.remove(); }
        const statusContainer = document.getElementById('status-overlay-container');
        function showLoadingOverlay(message) { statusContainer.innerHTML = `<div id="status-overlay"><div class="loader"></div><p>${message}</p></div>`; }
        function showStatusMessage(type, message) { const icon = type === 'success' ? '<i class="fas fa-check-circle text-5xl text-green-500"></i>' : '<i class="fas fa-times-circle text-5xl text-red-500"></i>'; statusContainer.innerHTML = `<div id="status-overlay">${icon}<p>${message}</p></div>`; setTimeout(hideStatusOverlay, 2000); }
        function hideStatusOverlay() { statusContainer.innerHTML = ''; }
        function toggleSidebar() { appState.isSidebarOpen = !appState.isSidebarOpen; document.getElementById('sidebar').classList.toggle('open'); }
        function displayGlobalError(message) { pageTitle.textContent = "Error"; pageContent.innerHTML = `<div class="text-center p-8 bg-gray-800 rounded-lg"><i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><h3 class="text-xl font-semibold text-red-400">Application Error</h3><p class="text-gray-400 mt-2">${message}</p><p class="text-xs text-gray-500 mt-4">This could be a temporary issue with the backend server or your network connection. Please try refreshing the page.</p><button id="retry-connection-btn" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Retry Connection</button></div>`; document.getElementById('retry-connection-btn').addEventListener('click', initialize); }

        // --- INITIALIZATION ---
        async function initialize() {
            navigateTo('login');
            showLoadingOverlay('Connecting to server...');
            try {
                const response = await fetch(config.backendUrl);
                if (!response.ok) throw new Error(`Backend is not responding. Status: ${response.status}`);
                console.log("Backend connection successful.");
                hideStatusOverlay();
                await checkAuthState();
            } catch (error) {
                console.error("Initialization Error:", error);
                hideStatusOverlay();
                displayGlobalError(error.message);
            }
        }

        initialize();
    </script>
</body>
</html>

